const Nt=[{keys:["1","h","help","ghelp"],description:"Show available commands",run:s=>s.help()},{keys:["2","st","status"],description:"Show game status",run:s=>s.status()},{keys:["3","n","next","day"],description:"Proceed to next day",run:s=>s.nextDay()},{keys:["4","s","save"],description:"Generate save code",run:s=>s.saveGame()},{keys:["5","l","load"],description:"Load game state",run:(s,e)=>e?s.loadGame(e):["> LOAD FAILED: NO SAVE CODE PROVIDED"]},{keys:["6","c","credits"],description:"Show game credits",run:s=>s.credits()},{keys:["7","r","rules"],description:"Show game rules",run:s=>s.rules()},{keys:["8","ex","exit"],description:"Exit game",run:s=>s.exit()}],Dt=[{keys:["nosferatu"],description:"Hidden cheat menu",run:s=>s.openCheatMenu()}],D={SAVE_VERSION:"1.0.0",INITIAL_BLOOD:10,INITIAL_MAX_WIVES:5,INITIAL_LEVEL:1,INITIAL_MAX_HP:50,INITIAL_STRENGTH:5,INITIAL_SPEED:5,INITIAL_CHARISMA:5,INITIAL_INTELLIGENCE:5,INITIAL_TACTICS:5,INITIAL_SEDUCTION:5},A={unknown:[{text:'> TYPE "ghelp" FOR GAME COMMANDS',group:"system",style:"separator"}],help:[{text:"> ====== VAMPIRE REQUIEM COMMANDS ======",group:"game",style:"warning"},{text:"> 1 / h - Show this help message",group:"game"},{text:"> 2 / st - Show current game status",group:"game"},{text:"> 3 / n - Choose action for the day",group:"game"},{text:"> 4 / s - Generate save code",group:"game"},{text:"> 5 / l / load <code> - Load game from save code",group:"game"},{text:"> 6 / c - Credits",group:"game"},{text:"> 7 / r / rules - Rules",group:"game"},{text:"> 8 / ex - Exit game and return to menu",group:"game"},{text:"> ======================================",group:"game",style:"warning"}],creator:[{text:"> ============== Credits ===============",group:"game",style:"separator"},{text:"> Pavel Gornostaev (idea and game design)",group:"game",style:"creative"},{text:"> And...",group:"game",style:"separator"},{text:"> Chat GPT (free)",group:"game",style:"creative"},{text:"> Grok (free)",group:"game",style:"creative"},{text:"> Gemini (free)",group:"game",style:"creative"},{text:"> DeppSeek (free)",group:"game",style:"creative"},{text:"> Copilot (free)",group:"game",style:"creative"},{text:"> And...",group:"game",style:"separator"},{text:"> Cursor banned me, so they're not getting a credit.",group:"game",style:"creative"},{text:"> ======================================",group:"game",style:"separator"},{text:`> Version: ${D.SAVE_VERSION}`,group:"game",style:"separator"}],tutorial:[{text:"> ======================================",group:"game",style:"separator"},{text:'> Inspired by the "World of Darkness" universe',group:"game",style:"dim"},{text:"> --------------------------------------",group:"game",style:"separator"},{text:"> You are a Kindred, newly awakened from a long slumber. The passing centuries have erased all memory of the world you once knew, leaving only an insatiable Hunger.",group:"game",style:"creative"},{text:'> To endure another night, enter "3". Remember: losing your last drop of BLOOD means facing Final Death.',group:"game",style:"creative"},{text:"> --------------------------------------",group:"game",style:"separator"},{text:"> THE ESSENCE OF IMMORTALITY (Attributes):",group:"game",style:"separator"},{text:"> - BLOOD: Your currency, your power, and your very existence. A true predator is never full. Should your veins run dry, you shall crumble into ash.",group:"game",style:"creative"},{text:"> - HP: The vessel that holds your soul. If your flesh is destroyed, you will fall into Torpor for centuries, losing your place in the Great Game.",group:"game",style:"creative"},{text:"> - STRENGTH: Physical dominance over mortals and beasts alike. Hone your might to crush the skulls of those who dare stand in your path.",group:"game",style:"creative"},{text:"> - SPEED: Supernatural celerity. Be the elusive shadow; this gift allows you to evade strikes that would otherwise claim your life.",group:"game",style:"creative"},{text:"> - CHARISMA: The magnetism of cursed blood. Legions of faithful thralls follow a true leader. Become one whose whisper cannot be disobeyed.",group:"game",style:"creative"},{text:"> - INTELLIGENCE: A razor-sharp mind sharpened by eons. The world has changed, but cunning is eternal. Outwit the most seasoned wanderers and lure them into your retinue.",group:"game",style:"creative"},{text:"> - TACTICS: The art of the Blood War. Without strategy, legions are but fodder. Become a grand commander to overcome the defenders of ancient strongholds.",group:"game",style:"creative"},{text:"> - SEDUCTION: A temptation beyond resistance. It allows you to recruit elite renegades and the most formidable protectors. This gift flourishes only when you surround yourself with concubines.",group:"game",style:"creative"},{text:"> DARK BONDS (Hidden Mechanics):",group:"game",style:"separator"},{text:'> - WIVES: Grant the "Kiss" to mortal maidens. Bound to you by blood, they shall prowl the night, gathering human cattle to bolster your armies.',group:"game",style:"creative"},{text:"> - BODYGUARD: Your shadows, your living shields. The most loyal of slaves, ready to perish in the flames if it means shielding their Master from harm.",group:"game",style:"creative"},{text:"> - WEREWOLF CASTLES: The bastions of your ancestral foes—the Lupines. These are dens of primal fury and the only source of vast treasures worthy of an Elder.",group:"game",style:"creative"},{text:"> ======================================",group:"game",style:"separator"}],exit:["> ======================================","> EXITING VAMPIRE REQUIEM...","> THE NIGHT ENDS","> ======================================",{text:'> TYPE "list" TO SEE AVAILABLE GAMES',group:"game",style:"separator"},{text:'> TYPE "ghelp" FOR GAME COMMANDS',group:"game",style:"separator"}],gameOver:[{text:"> ======================================",group:"error"},{text:"> ======== GAME OVER - YOU DIED ========",group:"error"},{text:"> ======================================",group:"error"},{text:"> Your blood has run dry...",group:"error"},{text:"> The dawn arrives, and with it, your end...",group:"error"},{text:"> ======================================",group:"error"},{text:'> TYPE "list" TO SEE AVAILABLE GAMES',group:"game",style:"separator"}],back:["^(o,_,o)^ SLINKING BACK TO THE SHADOWS..."],backNoSkipDay:["A lesser creature would seek rest. You choose to endure. Push forward to finish what you started. ^(o,_,o)^"],newLevel:(s,e)=>[{text:"> ======================================",group:"game",style:"warning"},{text:`> *** LEVEL UP! Reached level ${s} ***`,group:"game",style:"warning"},{text:`> [ + ${e} ] Attribute Fetters gained!`,group:"game",style:"warning"}],addExp:s=>[{text:`> EXP: [ + ${s} ]`,group:"system"}],addBlood:s=>[{text:`> BLOOD: [ + ${s} ]`,group:"system"}],noMoreBodyguards:[{text:"> ======================================",group:"system",style:"separator"},{text:"> Your shadow is already occupied by a sworn protector.",group:"error"},{text:"> Only one soul may hold the honor of being your personal shield.",group:"system",style:"creative"},{text:"> You must sever your current bond before binding a new guardian.",group:"system",style:"creative"},{text:"> ======================================",group:"system",style:"separator"}],bodyguardSavePlayer:[{text:"> ======== A DEBT PAID IN BLOOD ========",group:"system",style:"separator"},{text:"> ........._..........",group:"system",style:"separator"},{text:"> ........| |.........",group:"system",style:"separator"},{text:"> ........|_|.........",group:"system",style:"separator"},{text:"> .....o==[ ]==o......",group:"system",style:"separator"},{text:"> ........| |.........",group:"system",style:"separator"},{text:"> ........|/..........",group:"system",style:"separator"},{text:"> ....................",group:"system",style:"separator"},{text:"> ....... /|..........",group:"system",style:"separator"},{text:"> .......| |..........",group:"system",style:"separator"},{text:"> .......\\ /..........",group:"system",style:"separator"},{text:"> Your sentinel throws himself into the path of destruction!",group:"game",style:"creative"},{text:"> The steel intended for your heart find purchase in his flesh instead...",group:"system",style:"creative"},{text:"> His life flickers out to preserve your eternity.",group:"error",style:"creative"},{text:"> He is no more.",group:"error"},{text:"> ======================================",group:"system",style:"separator"}]},g={LEVEL_UNLOCK_WIFE:6,LEVEL_UNLOCK_BODYGUARD:10,LEVEL_UNLOCK_CASTLE:8,WIVES_MAX:5,WIFE_COST_WEIGHTS:{seduction:.6,charisma:1.2,army:{weak:.5,normal:1.2,strong:3}},WIFE_BASE_RECRUIT_COST:120,WIFE_COST_SCALE:14,WIFE_UTILITY_COST_FACTOR:.95,WIFE_LEVEL_COST_FACTOR:.035,WIFE_LEVEL_COST_CAP:3,WIFE_SEDUCTION_VARIANCE:9,WIFE_SEDUCTION_CLAMP:18,WIFE_LEVEL_INFLUENCE:.4,WIFE_ATTRIBUTE_LEVEL_FACTOR:.15,WIFE_ATTRIBUTE_PLAYER_FACTOR:.15,WIFE_ATTRIBUTE_RANDOM_CAP:18,WIFE_ARMY_BASE_BONUS:{weak:.25,normal:.15,strong:.05},WIFE_ARMY_RANGE_BONUS:{weak:.35,normal:.25,strong:.05}},f={DAILY_BLOOD_UPKEEP_BASE:2,DAILY_BLOOD_PER_WIFE:25,DAILY_BLOOD_PER_BODYGUARD:100,ARMY_UPKEEP_WEAK:1,ARMY_UPKEEP_NORMAL:2,ARMY_UPKEEP_ELITE:4,ARMY_DISSOLVE_TAX_BASE:.5,ARMY_DISSOLVE_TAX_PER_EXP:.002,ARMY_DISSOLVE_TAX_MAX:5,ARMY_DISSOLVE_MIN_COST:1,ARMY_RECRUIT_MIN_BLOOD:150,ARMY_BASE_CHANCE_RECRUITE:35,CASTLE_ASSAULT_COST:20,GUARD_EXP_REWARD_RATE:1.8,GUARD_BLOOD_REWARD_RATE:.5,VILLAGE_EXP_REWARD_RATE:2,VILLAGE_BLOOD_REWARD_RATE:-.85,WIFE_RECRUIT_DISCOUNT:.8,BODYGUARD_MIN_PRICE:2e3,BODYGUARD_DUTY_PERCENT:.08,BODYGUARD_PRICE_FACTOR_MIN:10,BODYGUARD_PRICE_FACTOR_MAX:20,BODYGUARD_RECRUIT_CHANCE_MIN:30,BODYGUARD_RECRUIT_CHANCE_MAX:80,BLOOD_WEALTH_THRESHOLD:5e3},C={BASE_REWARD_BY_TIER:{1:140,2:210,3:300,4:420,5:560},REWARD_MIN:1e4,REWARD_LEVEL_BASE:1e4,REWARD_LEVEL_GROWTH:1.2,REWARD_LEVEL_OFFSET:8,REWARD_TIER_MULTIPLIER:.18,REWARD_ARMY_LOG_BASE:80,REWARD_ARMY_LOG_SCALE:.04,REWARD_ARMY_MAX_BONUS:1.18,REWARD_VARIANCE_MIN:.88,REWARD_VARIANCE_MAX:1.18,REWARD_UNIQUE_NUDGE:.012,REWARD_UNIQUE_STEP:.01,REWARD_UNIQUE_ATTEMPTS:20},E={PLAYER_HIT_CHANCE:.87,PLAYER_CRIT_CHANCE:.26,GUARD_HIT_CHANCE:.61,GUARD_CRIT_CHANCE:.12,PLAYER_DODJE_CHANCE_MAX:.85,PLAYER_DAMAGE_MIN:6,PLAYER_DAMAGE_MAX:14,GUARD_DAMAGE_MIN:4,GUARD_DAMAGE_MAX:10,WIFEDUEL_ALL_MIN_DAMAGE_MIN:3,WIFEDUEL_ALL_MIN_DAMAGE_MAX:7,CRIT_DAMAGE_MULTIPLIER:2,CRIT_GUARD_DAMAGE_MULTIPLIER:1.6,GUARD_BASE_HP:30,LEVEL_GUARD_HP_BONUS:5,STRENGTH_DAMAGE_MULTIPLIER:.1,SPEED_DODGE_CHANCE:.05,GUARD_LEVEL_DAMAGE_BONUS:1,MAX_DUEL_ROUNDS:20,DUEL_CRIT_AVAILABLE_MIN_LEVEL:4,MAX_WIFE_DUEL_ROUNDS:20,MAX_BODYGUARD_DUEL_ROUNDS:10,BODYGUARD_DAMAGE_MIN:1,BODYGUARD_DAMAGE_RAND_MIN:20,BODYGUARD_DAMAGE_RAND_MAX:40,BODYGUARD_CHANCE_BASE:50,BODYGUARD_CHANCE_PER_DIFF:2,BODYGUARD_CHANCE_RAND_MIN:-10,BODYGUARD_CHANCE_RAND_MAX:10},Ge={STAGE_TURNS:20,STAGE_BASE_RATIOS:[.3,.3,.4],STAGE_RATIO_VARIANCE:.2,STAGE_RATIO_MIN:.15,STAGE_RATIO_MAX:.5,STAGE_RATIO_FINAL_MAX:.55,STAGE3_MIN:.2,GARRISON_VARIANCE_MIN:-.35,GARRISON_VARIANCE_MAX:.5,GARRISON_SCALING_FACTOR:3,GARRISON_SCALING_EXP:.5,GARRISON_BASE_FACTOR:.3,GARRISON_TOTAL_MIN:80,GARRISON_STAGE_MIN:18,DESERTER_RATE_BASE:.12,DESERTER_RETURN_MIN:.7,DESERTER_RETURN_MAX:.8,REROLL_BASE_COST:6,REROLL_GROWTH:1.75,REROLL_GLOBAL_LIMIT:7,ARMY_POWER_WEIGHTS:{weak:1,normal:2,elite:4},GARRISON_POWER_WEIGHTS:{weak:1,normal:2,strong:3},BASE_POWER_BY_TIER:{1:90,2:130,3:180,4:240,5:310},STAGE_POWER_MULTIPLIERS:[.85,1,1.15],GARRISON_COMPOSITION:{1:{weak:.6,normal:.3,strong:.1},2:{weak:.5,normal:.35,strong:.15},3:{weak:.4,normal:.4,strong:.2},4:{weak:.3,normal:.45,strong:.25},5:{weak:.25,normal:.4,strong:.35}},STAGE_MODIFIERS:{1:{playerHitBonus:-.05,playerCritBonus:-.02,playerDamageMul:.95,enemyHitBonus:.02,enemyCritBonus:0,enemyDamageMul:.9,lossMultiplier:.9,deserterBonus:0},2:{playerHitBonus:0,playerCritBonus:.01,playerDamageMul:1,enemyHitBonus:.05,enemyCritBonus:.02,enemyDamageMul:1.25,lossMultiplier:1.15,deserterBonus:.02},3:{playerHitBonus:.05,playerCritBonus:.08,playerDamageMul:1.05,enemyHitBonus:.08,enemyCritBonus:.05,enemyDamageMul:1.1,lossMultiplier:1.05,deserterBonus:.08}},BOSS_PROFILE:{BASE_HP:140,TIER_HP:55,LEVEL_HP:6,DAMAGE_MIN_BASE:10,DAMAGE_MIN_TIER:4,DAMAGE_MIN_LEVEL:.4,DAMAGE_MAX_BASE:18,DAMAGE_MAX_TIER:6,DAMAGE_MAX_LEVEL:.6,SPEED_BASE:6,SPEED_TIER:2,SPEED_LEVEL:.25,STRENGTH_BASE:8,STRENGTH_TIER:3,STRENGTH_LEVEL:.35,FEROCITY_BASE:.12,FEROCITY_TIER:.05},STAGE_BREAK_REMAIN_BASE:.4,STAGE_BREAK_REMAIN_MIN:.3,STAGE_BREAK_REMAIN_MAX:.7,STAGE_BREAK_TACTICS_SCALE:.002,STAGE_BREAK_ARMY_SCALE:.2,STAGE_BREAK_ARMY_MAX:.18,ESTIMATE_RATIO_STEEPNESS:4.5,ESTIMATE_TACTICS_SCALE:.0012,ESTIMATE_TIER_RATIO_BASE:1,ESTIMATE_TIER_RATIO_STEP:.25,ESTIMATE_SMALL_ARMY_RATIO:.45,ESTIMATE_SMALL_ARMY_MIN:.01,ESTIMATE_SMALL_ARMY_MAX:.02,SIEGE_SURVIVAL_MIN:.15,SIEGE_SURVIVAL_MAX:.95,SURVIVAL_WARNING_THRESHOLD:.08,SIEGE_STAGE_LOSS_FLOOR:{1:1.1,2:1.43,3:.97},SIEGE_STAGE_LOSS_TIER_BONUS:.01,SIEGE_STAGE_LOSS_MAX:.5,BASE_PLAYER_HIT:.75,BASE_PLAYER_CRIT:.15,BASE_ENEMY_HIT:.7,BASE_ENEMY_CRIT:.1,CRIT_MULTIPLIER:2};function Bt(s){const e=s.army,t=s.companions.wives.length,r=s.companions.bodyguards.length,a=f.DAILY_BLOOD_UPKEEP_BASE+t*f.DAILY_BLOOD_PER_WIFE+r*f.DAILY_BLOOD_PER_BODYGUARD+e.weak*f.ARMY_UPKEEP_WEAK+e.normal*f.ARMY_UPKEEP_NORMAL+e.elite*f.ARMY_UPKEEP_ELITE;return s.player.blood-=a,{cost:a,gameOver:s.player.blood<0}}class V{options;config;constructor(e){Array.isArray(e)?(this.options=e.filter(t=>!t.disabled),this.config={options:this.options}):(this.options=e.options.filter(t=>!t.disabled),this.config=e)}renderTextBlock(e,t){(Array.isArray(e.lines)?e.lines:[e.lines]).forEach(a=>{t.push(this.styledLine(a,e.style))})}render(){const e=[],t=this.config.decoration?.width??this.calculateWidth();return this.config.decoration?.top&&e.push(this.styledLine(this.config.title?this.formatTitle(this.config.title,t,this.config.decoration.top):this.repeat(this.config.decoration.top,t),this.config.decoration.topStyle)),this.config.prompt&&e.push(this.styledLine(this.config.prompt,this.config.promptStyle)),this.options.forEach((r,a)=>{e.push(this.styledLine(`[ ${a+1} ] - ${r.label}`,this.config.optionStyle))}),this.config.footerText&&this.renderTextBlock(this.config.footerText,e),this.config.decoration?.bottom&&e.push(this.styledLine(this.repeat(this.config.decoration.bottom,t),this.config.decoration.bottomStyle)),e}processInput(e){const t=parseInt(e,10)-1;return isNaN(t)||t<0||t>=this.options.length?null:{optionId:this.options[t].id,optionIndex:t+1}}styledLine(e,t){return t?{text:`> ${e}`,group:t.group,style:t.style}:`> ${e}`}calculateWidth(){return Math.max(30,this.config.title?.length??0,this.config.prompt?.length??0,...this.options.map(e=>e.label.length+6))}repeat(e,t){return e.repeat(t)}formatTitle(e,t,r){const a=` ${e} `,o=Math.floor((t-a.length)/2);return r.repeat(o)+a+r.repeat(t-o-a.length)}}const Ve={data:[{name:"Shadowmere",description:"A sunless village built on the edge of a pitch-black lake."},{name:"Raven's Hollow",description:"A place where the croaking of crows drowns out human voices."},{name:"Bloodmoor",description:"A swampy settlement where the soil turns crimson after every rain."},{name:"Gloomhaven",description:"A fog-shrouded town where the streetlamps are never extinguished."},{name:"Mournstead",description:"A village that serves as a permanent wake for a long-forgotten lord."},{name:"Dreadcliff",description:"Built on a jagged precipice where the wind sounds like screaming."},{name:"Ironwood",description:"A fortified hamlet surrounded by trees that bleed black sap."},{name:"Mistvale",description:"A valley town where the mist hides things that should stay buried."},{name:"Nightfall",description:"The sun sets two hours early here, blocked by a cursed mountain."},{name:"Grave's End",description:"A small town built literally on top of an ancient, overflowing cemetery."},{name:"Bonefield",description:"Farmers here often plow up skeletons instead of stones."},{name:"Corpse Run",description:"A narrow settlement along a river that carries the dead to the sea."},{name:"Deadman's Crossing",description:"A lonely outpost at a crossroads where no traveler stays twice."},{name:"Skullcap",description:"A village carved into a hill that resembles a massive, bleached skull."},{name:"Witherwood",description:"The trees here haven't grown a leaf in three centuries."},{name:"Blightside",description:"A decaying village where the very air tastes of ash and rot."},{name:"Cinderstone",description:"A settlement built from the charred ruins of a burned cathedral."},{name:"Ashcroft",description:"Grey flakes fall from the sky here, even in the middle of summer."},{name:"Sorrow's Peak",description:"A mountain village where the inhabitants have forgotten how to laugh."},{name:"Weeping Willows",description:"The trees surrounding this pond are said to house trapped souls."},{name:"Forsaken Grove",description:"A place abandoned by the gods, now ruled by older, darker things."},{name:"Silent Waters",description:"A lakeside village where not even a ripple disturbs the surface."},{name:"Pale Harbor",description:"A coastal town where the fishermen only cast their nets at midnight."},{name:"Coldmist",description:"The frost on the windows here forms patterns of pleading faces."},{name:"Bitterwell",description:"The village water is dark, cold, and tastes faintly of iron."},{name:"Hollow's Gate",description:"The entrance to this town is guarded by two headless statues."},{name:"Crimson Ridge",description:"The cliffs here are stained red by an ancient, unceasing curse."},{name:"Sanguine Springs",description:"Warm, red water bubbles up from the ground in the town square."},{name:"Nocturne",description:"A town that only comes alive after the final ray of sunlight fades."},{name:"Bat's Wing",description:"Built under a massive rock overhang that keeps the village in eternal shadow."},{name:"Veiled Keep",description:"A village hidden behind a waterfall of thick, grey smog."},{name:"Eternal Rest",description:"The locals sleep in stone coffins to protect themselves from the night."},{name:"Moonlight Meadow",description:"A deceptive name for a place where the moon reveals your true form."},{name:"Silverstake",description:"A tense village where every door is barred with silver and holy symbols."},{name:"Redwinter",description:"Snow falls here in a pale shade of pink, smelling of copper."},{name:"Fangside",description:"The architecture here is sharp, jagged, and predatory."},{name:"Thornbury",description:"Surrounded by a wall of briars that seem to move when you aren't looking."},{name:"Bramblefoot",description:"A poor village where the mud is thick and the people are desperate."},{name:"Wolfden",description:"The howling from the nearby woods never stops, day or night."},{name:"Crow's Nest",description:"A vertical village built into the side of a dead, colossal tree."},{name:"Serpent's Creek",description:"The river here winds like a snake and hides scaled horrors."},{name:"Mossgrave",description:"Everything here is covered in a thick, suffocating layer of green mold."},{name:"Elderwood",description:"Home to trees that have seen the rise and fall of a dozen empires."},{name:"Darkwater",description:"A fishing village where the catch often has too many eyes."},{name:"Murkwood",description:"So little light reaches the ground that the villagers use bioluminescent fungi."},{name:"Hexwood",description:"The wood used to build these houses still whispers to the residents."},{name:"Cursed Landing",description:"A port where ships arrive empty, their crews gone without a trace."},{name:"Witch's End",description:"A village built around the scorched stake of a legendary sorceress."},{name:"Spirit's Rest",description:"Translucent figures are often seen performing chores alongside the living."},{name:"Ghostlight",description:"Eerie blue flames dance in the windows of abandoned cottages."},{name:"Phantom Ridge",description:"A mountain pass where the wind carries the sounds of a ghostly army."},{name:"Wraith's Walk",description:"A single long street where no one dares to walk alone after dark."},{name:"Eldritch Vale",description:"The stars above this valley don't match any known constellations."},{name:"Ironmire",description:"A swampy village where the mud is as heavy and cold as metal."},{name:"Steelgate",description:"A grim fortress-village that guards the pass into the vampire lands."},{name:"Blackreach",description:"Built in the deepest part of a canyon where sunlight never reaches."},{name:"Smogwood",description:"The air is thick with the soot of a thousand coal fires."},{name:"Ashvale",description:"A silent valley where every sound is muffled by a layer of grey dust."},{name:"Burnthaven",description:"The villagers live in the stone basements of houses burned long ago."},{name:"Castleview",description:"Every window in this village faces the ominous spire of the local lord."},{name:"Baron's Folly",description:"A decadent, decaying village built for a lord who went mad."},{name:"Count's Landing",description:'A meticulously clean village that pays a heavy "blood tax" every month.'},{name:"Manor's End",description:"A cluster of hovels huddling at the gates of a dark, gothic estate."},{name:"Highspire",description:"A village on a needle-like rock, reachable only by a terrifying lift."},{name:"Heritage Hill",description:"The residents here are obsessed with bloodlines and ancient secrets."},{name:"Shadowfell",description:"A place where shadows are longer and darker than they should be."},{name:"Nightshade",description:"Famous for its poisonous gardens and beautiful, deadly women."},{name:"Bloodrose",description:"A village surrounded by flowers that only bloom in the presence of death."},{name:"Ironheart",description:"A cold, industrial village where the people are as hard as the ore they mine."},{name:"Stonecold",description:"A village where the fire provides no warmth and the bread is like flint."},{name:"Winter's Grip",description:"Caught in a localized ice age that hasn't thawed for decades."},{name:"Frostbite",description:"The inhabitants here have pale, blue-tinged skin and cold hearts."},{name:"Storm's Edge",description:"Perpetual lightning illuminates the ruined towers of this town."},{name:"Final Rest",description:"The last stop for travelers before they enter the Forbidden Lands."},{name:"Blackwood",description:"The timber from these trees is naturally black and smells of incense."},{name:"Shiverpeak",description:"A high-altitude village where the thin air causes vivid hallucinations."},{name:"Duskhaven",description:"A town that exists in a state of perpetual twilight."},{name:"Greywatch",description:"A village of watchers who stare at the horizon for an enemy that never comes."},{name:"Omen's End",description:"The birds here only fly in patterns that predict misfortune."},{name:"Hollowcreek",description:"The creek bed is dry, but the sound of rushing water is still heard."},{name:"Carrion Gate",description:"Vultures circle this village in numbers that block out the sun."},{name:"Bleakwood",description:"A place of absolute poverty where the only currency is hope, and it's scarce."},{name:"Widow's Peak",description:"Named for the women who wait for husbands lost to the vampire's hunt."},{name:"Marrowbridge",description:"A bridge made of giant bones leads into this unsettling settlement."},{name:"Stillwater",description:"No birds sing and no insects buzz in this unnervingly quiet village."},{name:"Plaguebury",description:"The doors are marked with fading yellow crosses from a past epidemic."},{name:"Rotwood",description:"The smell of damp earth and decay is inescapable here."},{name:"Gravemark",description:"A village where every house is built next to an upright tombstone."},{name:"Night's Whisper",description:"The wind here sounds like it's saying your name."},{name:"Soul's Anchor",description:"A village of people who sold their shadows for a chance at eternal life."},{name:"Veinwood",description:"The vines growing on the walls pulse with a faint, rhythmic light."},{name:"Bloodwell",description:"The central well was sealed a century ago, but it still leaks red."},{name:"Cryptside",description:"Half the village is built into the side of an ancient catacomb."},{name:"Mourningstar",description:"A village that celebrates the death of the sun every evening."},{name:"Shadowpoint",description:"A jagged spire of rock that casts a shadow over the whole town."},{name:"Grim's Reach",description:"A village that feels like it's being slowly pulled into the earth."},{name:"Darkling",description:'Home to a sect of people who have sewn their eyes shut to "see better".'},{name:"Hemlock",description:"The tea served here is bitter, and the sleep it brings is deep."},{name:"Bitterfield",description:"Nothing edible grows here, only thorns and grey weeds."},{name:"Last Gasp",description:"The final settlement before the world dissolves into the Great Void."}]};function X(s){const e=Math.floor(Math.random()*Ve.data.length),t=1200+Math.floor(Math.random()*700),r=Ve.data[e],a=Math.min(8,Math.max(1,s+1+Math.floor(Math.random()*2)));let o;s<=1?o={weak:80+Math.floor(Math.random()*40),normal:40+Math.floor(Math.random()*30),strong:10+Math.floor(Math.random()*15)}:s<=3?o={weak:100+Math.floor(Math.random()*50),normal:80+Math.floor(Math.random()*40),strong:30+Math.floor(Math.random()*20)}:o={weak:150+Math.floor(Math.random()*50),normal:120+Math.floor(Math.random()*50),strong:60+Math.floor(Math.random()*30)};const n=Math.max(20,100-a*12);return{id:`village_${Date.now()}_${Math.random()}`,name:r.name,description:r.description,foundedYear:t,guardLevel:a,population:o,successChance:n}}function Fe(){const s=[];return s.push(X(0),X(1)),s.push(X(2),X(4)),s.push(X(7)),s}const Ke=["Lilith","Morgana","Elsa","Irina","Victoria","Ludmila","Olga","Anna","Elena","Anastasia","Sophia","Valeria","Daria","Galina","Zhanna","Isabella","Camila","Kristina","Laura","Margarita","Nadezhda","Oksana","Polina","Rosa","Sabina","Tatiana","Faina","Halina","Cecilia","Charlotte","Eleanor","Beatrix","Seraphina","Drusilla","Vespera","Gisela","Hecate","Rowena","Sybil","Clara","Agatha","Bernadette","Cordelia","Dorothy","Edith","Florence","Gertrude","Hilda","Ida","Juliet","Katarina","Lenora","Mildred","Noor","Ophelia","Pandora","Quinn","Rowan","Selene","Theodora","Ursula","Valeska","Winifred","Xenia","Yvonne","Zora","Amalia","Belen","Cindra","Damaris","Elowen","Freya","Gretel","Helga","Isolde","Jezebel","Kira","Loredana","Maeve","Nyx"],Xe=["Witch","Tavern Wench","Baron's Daughter","Nun","Merchant","Huntress","Schoolmistress","Lord's Handmaiden","Sorceress","Innkeeper","Alchemist","Grave Robber","Plague Nurse","Herbalist","Midwife","Sin-eater","Fortune Teller","Blacksmith's Apprentice","Seamstress","Executioner's Daughter","Exiled Noblewoman","Rat Catcher","Bone Collector","Candle Maker","Apothecary","Laundress","Beggar Queen","Mercenary","Traveling Minstrel","Falconer","Widow of the Night","Cemetery Keeper","Bookkeeper","Poisoner","Scullery Maid","Leatherworker","Clockmaker","Stray Orphan","Scribe","Village Elder","Moon-worshipper","Bounty Hunter","Baker","Wine Merchant","Jeweler","Fallen Paladin","Cultist Initiate","Sheep Herder","Fisherwoman","Silk Weaver","Dyer","Glassblower","Cartographer","Minstrel","Soothsayer","Inquisitor's Aide","Woodcutter","Tavern Cook","Vagabond","Mystic"];function kt(s){const e=Ke[Math.floor(Math.random()*Ke.length)],t=Xe[Math.floor(Math.random()*Xe.length)],r=18+Math.floor(Math.random()*20),a=s.stats.seduction,o=Math.floor(s.level*g.WIFE_LEVEL_INFLUENCE),n=-Math.floor(g.WIFE_SEDUCTION_VARIANCE/2)+Math.floor(Math.random()*(g.WIFE_SEDUCTION_VARIANCE+1));let i=a+o+n;i=Math.max(a-g.WIFE_SEDUCTION_CLAMP,Math.min(a+g.WIFE_SEDUCTION_CLAMP,i));function l(k,w){const ce=Math.floor(w*g.WIFE_ATTRIBUTE_LEVEL_FACTOR),J=Math.floor(k*g.WIFE_ATTRIBUTE_PLAYER_FACTOR),F=Math.floor(Math.random()*g.WIFE_ATTRIBUTE_RANDOM_CAP);return ce+J+F}const u=l(s.stats.charisma,s.level),p=l(s.stats.intelligence,s.level),c=l(s.stats.tactics,s.level),d=Math.max(s.level,1),I=Math.floor(d*g.WIFE_ARMY_BASE_BONUS.weak),_=3+Math.floor(d*g.WIFE_ARMY_RANGE_BONUS.weak),R=Math.floor(d*g.WIFE_ARMY_BASE_BONUS.normal),v=2+Math.floor(d*g.WIFE_ARMY_RANGE_BONUS.normal),L=Math.floor(d*g.WIFE_ARMY_BASE_BONUS.strong),x=Math.floor(Math.sqrt(d+g.WIFE_ARMY_RANGE_BONUS.strong)),y={weak:I+Math.floor(Math.random()*(_+1)),normal:R+Math.floor(Math.random()*(v+1)),strong:Math.min(L+Math.floor(Math.random()*(x+1)),Math.floor(d*.25))},M=u+p+c,T=y.weak*g.WIFE_COST_WEIGHTS.army.weak+y.normal*g.WIFE_COST_WEIGHTS.army.normal+y.strong*g.WIFE_COST_WEIGHTS.army.strong,b=i*g.WIFE_COST_WEIGHTS.seduction+M*g.WIFE_COST_WEIGHTS.charisma+T,B=g.WIFE_BASE_RECRUIT_COST+Math.pow(b,g.WIFE_UTILITY_COST_FACTOR)*g.WIFE_COST_SCALE,N=Math.min(1+s.level*g.WIFE_LEVEL_COST_FACTOR,g.WIFE_LEVEL_COST_CAP),U=Math.floor(B*N);return{id:`wife_${e}_${Date.now()}_${Math.random()}`,name:e,age:r,profession:t,recruitCost:U,bonus:{seduction:i,charisma:u,intelligence:p,tactics:c},armyGenerationBonus:y}}function Ut(s,e=5){return Array.from({length:e},()=>kt(s))}const Gt=38,ze="=",Y={title:{group:"game",style:"creative"},prompt:{group:"system",style:"separator"},option:{group:"system",style:"creative"},footer:{group:"game",style:"description"}};function He(s,e,t,r){return{title:s,titleStyle:Y.title,prompt:e,promptStyle:Y.prompt,options:t,optionStyle:Y.option,decoration:{top:ze,bottom:ze,width:Gt,topStyle:Y.title,bottomStyle:Y.title},footerText:r?{lines:r,style:Y.footer}:void 0}}function Ht(s,e,t,r,a){return[{id:"recruit",label:"Replenish Army"},{id:"attack",label:"Attack Village Guards"},{id:"wife",label:"Seek a Wife",disabled:s<g.LEVEL_UNLOCK_WIFE},{id:"bodyguard",label:"Recruit a Bodyguard",disabled:s<g.LEVEL_UNLOCK_BODYGUARD}]}function $t(){return[{id:"attack_guard",label:"Attack village guard"}]}function Yt(s){return Math.floor(30+s*s*12+s*20)}function de(s){if(s<=5)return 2;const e=Math.floor((s-5)/4);return Math.min(2+e,6)}function $e(s,e){let t={...s},r=!1,a=s.level;for(t.experience+=e;t.experience>=t.nextLevelExpRequired;)t.experience-=t.nextLevelExpRequired,t.level+=1,a=t.level,t.nextLevelExpRequired=Yt(t.level),t.attributePointsAvailable+=de(t.level),r=!0;return{player:t,leveledUp:r,newLevel:a}}function yt(s,e,t={}){const r=s.level,a=e.level/r,o=Math.min(2,Math.max(.6,1+(a-1)*.65)),n=o*e.difficultyRating,i=10+Math.floor(r*2)+Math.floor(Math.sqrt(e.maxHp)*1.4);let l=Math.floor(i*n*(e.rewardProfile.bloodMultiplier??1)*(t.bloodMultiplier??1))+(t.flatBloodBonus??0);(t.isCost??!1)||(l+=Math.floor(Math.random()*5)),t.isCost&&(l=-Math.abs(l)),l=t.isCost?l:Math.max(1,l);const u=s.nextLevelExpRequired,p=.12,c=(o-1)*.15,d=Math.min(.3,p+c),I=Math.floor(u*d*(e.rewardProfile.expMultiplier??1)*(t.expMultiplier??1))+(t.flatExpBonus??0)+Math.floor(Math.random()*4);return{blood:t.isCost?Math.min(-1,l):Math.max(1,l),experience:Math.max(1,I)}}function ft(s){const e=s.companions.bodyguards.findIndex(t=>!t.used);return e===-1?!1:(s.companions.bodyguards.splice(e,1),!0)}function be(s){let e=s.state.player;const t=e.level,r=E.GUARD_BASE_HP,a=s.state.world.activeGuardLevel??e.level,o=Math.max(1,Math.floor((t+a)/2)),n=r+Math.floor(Math.pow(o,1.18)*E.LEVEL_GUARD_HP_BONUS);let i=Math.round(e.stats.maxHp),l=Math.round(e.stats.maxHp),u=Math.round(n),p=Math.round(n);const c={level:o,maxHp:n,difficultyRating:1,rewardProfile:{bloodMultiplier:1,expMultiplier:1}},d=[{text:"> ============= GUARD DUEL =============",group:"game",style:"separator"},{text:`> You are attacking the guard (HP: ${n} - LVL: ${o})...`,group:"game",style:"dim"},{text:"> Only one may stand. The struggle begins...",group:"game",style:"dim"},{text:"> --------------------------------------",group:"game",style:"separator"}];let I=0;for(;i>0&&u>0&&I<E.MAX_DUEL_ROUNDS;){if(I++,Math.random()<E.GUARD_HIT_CHANCE){const M=Math.min(E.PLAYER_DODJE_CHANCE_MAX,e.stats.speed*E.SPEED_DODGE_CHANCE);if(Math.random()>=M){let T=E.GUARD_DAMAGE_MIN+Math.floor(Math.random()*(E.GUARD_DAMAGE_MAX-E.GUARD_DAMAGE_MIN+1));T+=Math.floor(t*E.GUARD_LEVEL_DAMAGE_BONUS);const b=Math.random()<E.GUARD_CRIT_CHANCE;a>=E.DUEL_CRIT_AVAILABLE_MIN_LEVEL&&b?(T*=E.CRIT_GUARD_DAMAGE_MULTIPLIER,d.push({text:`> [${Math.max(1,u)}/${p}] CRITICAL! The Guard tears through your defenses! (-${T.toFixed(0)} HP)`,group:"error"})):d.push({text:`> [${Math.max(1,u)}/${p}] The Guard delivers a blow! (-${T.toFixed(0)} HP)`,group:"error"}),i=Math.max(0,Math.round(i-Math.max(1,T)))}else d.push({text:`> [${u}/${p}] The Guard lunges at you...`,group:"error"}),d.push({text:`> [${i}/${l}] You blur past the strike! Ha-ha-ha...`,group:"game",style:"success"})}else d.push({text:`> [${u}/${p}] The Guard misses!`,group:"error"});if(i<=0)break;if(Math.random()<E.PLAYER_HIT_CHANCE){let M=E.PLAYER_DAMAGE_MIN+Math.floor(Math.random()*(E.PLAYER_DAMAGE_MAX-E.PLAYER_DAMAGE_MIN+1));M+=Math.floor(e.stats.strength*E.STRENGTH_DAMAGE_MULTIPLIER),Math.random()<E.PLAYER_CRIT_CHANCE?(M*=E.CRIT_DAMAGE_MULTIPLIER,d.push({text:`> [${Math.max(1,i)}/${l}] CRITICAL! A devastating strike! (-${M.toFixed(0)} HP)`,group:"game",style:"success"})):d.push({text:`> [${Math.max(1,i)}/${l}] You land a blow on the Guard! (-${M.toFixed(0)} HP)`,group:"game"}),u=Math.max(0,Math.round(u-Math.max(1,M)))}else d.push({text:`> [${i}/${l}] You miss!`,group:"game"})}if(I>=E.MAX_DUEL_ROUNDS&&i>0&&u>0){const M=Math.max(1,Math.floor(e.blood*.03));return M+1>e.blood?(e.blood=0,{state:s.state,messages:d,dayConsumed:!0,gameOver:!0}):(e.blood-=M,d.push({text:"> ========= FORCES IN STALEMATE ========",group:"error",style:"separator"},{text:"Your vampiric might clashed evenly with the guard's fury. No victor.",group:"error",style:"separator"},{text:`The Beast exacts tribute: BLOOD [ -${M} ] Vitae.`,group:"error"},{text:`Current BLOOD [ ${e.blood} ].`,group:"system"},{text:"> ======================================",group:"error",style:"separator"},{text:`> Day passes. ${A.back}`,group:"game",style:"separator"}),{state:s.state,messages:d,dayConsumed:!0,gameOver:!1})}if(i<=0)return ft(s.state)?(d.push(...A.bodyguardSavePlayer),e.combatState.currentHp=Math.floor(e.stats.maxHp*.3),d.push({text:"> You survive, but the guard escapes...",group:"system"},{text:"> Day passes. Returning to actions...",group:"game",style:"separator"}),{state:s.state,messages:d,dayConsumed:!0,gameOver:!1}):(e.blood=0,{state:s.state,messages:d,dayConsumed:!0,gameOver:!0});const{blood:R,experience:v}=yt(e,c,{bloodMultiplier:f.GUARD_EXP_REWARD_RATE,expMultiplier:f.GUARD_BLOOD_REWARD_RATE});e.blood+=R,s.state.statistics.defeatedGuards+=1;const{player:L,leveledUp:x,newLevel:y}=$e(e,v);return s.state.player=L,d.push({text:"> GUARD DEFEATED!",group:"game"}),d.push(...A.addBlood(R)),d.push(...A.addExp(v)),x?(d.push(...A.newLevel(y,de(y))),d.push({text:"> ======================================",group:"game",style:"warning"})):(d.push({text:"> ======================================",group:"game",style:"separator"}),s.silentDayEnd?d.push({text:`> ${A.backNoSkipDay}`,group:"game",style:"separator"}):d.push({text:`> Day passes. ${A.back}`,group:"game",style:"separator"})),{state:s.state,messages:d,dayConsumed:!x,gameOver:e.blood<=0,leveledUp:x,newLevel:y}}function Et(s){return Math.min(.1+s*.12,.7)}let h=null;function oe(s){const{state:e}=s,t=[];return h?h.cachedDay!==e.world.currentDay&&(h.villageList=Fe(),h.cachedDay=e.world.currentDay,h.womenList=[],h.womenCachedDay=void 0,h.womenCachedVillageId=void 0):h={selectedVillageId:"",submenu:"main",villageList:Fe(),womenList:[],cachedDay:e.world.currentDay},t.push({text:"> =========== CHOOSE VILLAGE ===========",group:"system",style:"creative"}),t.push({text:"> Available villages for raid:",group:"game",style:"separator"}),h.villageList.forEach((r,a)=>{const o=r.guardLevel<=2?"0.5x":r.guardLevel<=4?"1x":"2x";t.push({text:`> [ ${a+1} ] - "${r.name}"`,group:"error"}),t.push({text:`> (Founded: ${r.foundedYear}) - "${r.description}"`,group:"system",style:"dim"}),t.push({text:`> INHABITANTS: FRAIL [ ${r.population.weak} ] ' FIT [ ${r.population.normal} ] ' STALWART [ ${r.population.strong} ]`,group:"game",style:"dim"}),t.push({text:`> - GUARD LVL: (${r.guardLevel}) ' SECRECY: (${r.successChance}%)`,group:"system",style:"creative"}),t.push({text:`> - BLOOD BONUS: (${o})`,group:"error",style:"creative"})}),t.push({text:"> [ 0 ] - Back",group:"system",style:"title"}),t.push({text:"> ======================================",group:"system",style:"creative"}),{state:e,messages:t,dayConsumed:!1}}function $(s){const{state:e,villageIndex:t}=s;if(!h||t<0||t>=h.villageList.length)return{state:e,messages:["> Error: Incorrect village selection"],dayConsumed:!1};const r=h.villageList[t];h.selectedVillageId=r.id,(!h.womenList.length||h.womenCachedDay!==e.world.currentDay||h.womenCachedVillageId!==r.id)&&(h.womenList=Ut(e.player),h.womenCachedDay=e.world.currentDay,h.womenCachedVillageId=r.id);const o=Ht(e.player.level,e.companions.wives.length>0,e.companions.wives.length,e.companions.maxWives,!!e.companions.bodyguards);s.state.world.activeGuardLevel=r.guardLevel;const n=He(`VILLAGE ACTIONS - ${r.name}`,`Guard Level: ${r.guardLevel}`,o,["[ 0 ] - Back"]),l=new V(n).render();return{state:e,messages:l,dayConsumed:!1}}function pe(s,e){const t=s-e;return 1/(1+Math.exp(-t/15))}function me(s,e){return Math.floor(s*e)}function ge(s,e){if(s<=0)return 0;const t=Math.max(0,.6-e*.02);return Math.random()<t?0:Math.floor(Math.pow(Math.random(),.6-Math.min(.4,e*.005))*s)}function Pt(s){const{state:e}=s;return h?At({state:e}):{state:e,messages:["> Error: Village session not initialized"],dayConsumed:!1}}function At(s){const{state:e}=s,t=[];if(!h)return{state:e,messages:["> Error: Village session not initialized"],dayConsumed:!1};const r=Le();if(!r)return{state:e,messages:["> Error: No village selected"],dayConsumed:!1};const a=Et(r.guardLevel);if(Math.random()<a){const We=be({state:s.state});return{...We,messages:[{text:"> The village guards noticed your actions...",group:"error"},...We.messages]}}t.push({text:"> ======= REPLENISHING THE HOST ========",group:"game",style:"creative"}),t.push({text:`> YOU ARE IN "${r.name.toUpperCase()}"`,group:"game",style:"creative"}),t.push({text:"> ======================================",group:"game",style:"creative"}),t.push({text:"> You approach the village, exuding a supernatural charisma...",group:"game",style:"creative"});const o=f.ARMY_BASE_CHANCE_RECRUITE,n=r.successChance*.6,i=r.guardLevel*-4,l=e.player.stats.charisma*.8,u=e.player.stats.seduction*1.2,p=o+n+i+l+u,c=Math.max(8,Math.min(92,p)),d=Math.random()*100<c;let I=s.state.player.blood;if(t.push({text:`> Recruitment chance: ${c.toFixed(0)}%% (Village: ${r.successChance}%, Guard: ${r.guardLevel})`,group:"system",style:"dim"}),!d)return t.push({text:"> The villagers resist your influence! Your efforts yield nothing.",group:"error"}),t.push({text:"> ======================================",group:"game",style:"creative"}),t.push({text:`> Day passes. ${A.back}`,group:"game",style:"separator"}),{state:e,messages:t,dayConsumed:!0};c>=85?t.push({text:"> Your charisma **OVERWHELMS** them — they kneel before you!",group:"game",style:"creative"}):c>=70?t.push({text:"> Your supernatural allure sways the crowd!",group:"game",style:"creative"}):t.push({text:"> A few villagers succumb to your influence...",group:"game",style:"creative"});const _=e.player.stats.seduction*1.5+Math.log(e.player.level+1)*10,R=pe(_,20),v=pe(_,50),L=pe(_,90),x=me(r.population.weak,R),y=me(r.population.normal,v),M=me(r.population.strong,L),T=ge(x,e.player.level),b=ge(y,e.player.level),B=ge(M,e.player.level);if(T===0&&b===0&&B===0)return t.push({text:"> ✞ Adept of THE HOLY INQUISITION have taken up residence in this village. You choose not to court disaster.",group:"error"}),t.push({text:`> Your SEDUCTION [ ${e.player.stats.seduction} ] is insufficient; you cannot charm your way past the stake.`,group:"game",style:"creative"}),t.push({text:"> ======================================",group:"game",style:"creative"}),t.push({text:`> Day passes. ${A.back}`,group:"game",style:"separator"}),{state:e,messages:t,dayConsumed:!0};const N=T+b+B,U={level:r.guardLevel,maxHp:1,difficultyRating:Math.min(2,1+r.guardLevel*.25),rewardProfile:{expMultiplier:f.VILLAGE_EXP_REWARD_RATE,bloodMultiplier:f.VILLAGE_BLOOD_REWARD_RATE,isCost:!0}},{experience:k,blood:w}=yt(e.player,U,{expMultiplier:1+e.player.stats.seduction*.02+N*.01,bloodMultiplier:1+r.guardLevel*.35+N*.15,isCost:!0});if(e.player.blood+w<0)return t.push({text:`> You sense that approximately [ ${Math.abs(w)} ] Vitae is required to enthrall this village.`,group:"error"}),t.push({text:`> Current Reserves: [ ${I} ] Vitae remains in your veins.`,group:"system"}),t.push({text:"> Your veins run dry. You lack the Vitae to dominate this flock...",group:"error"}),t.push({text:"> The Beast rages within; your hunger shatters your control.",group:"error"}),t.push({text:"> ======================================",group:"game",style:"creative"}),t.push({text:`> Day passes. ${A.back}`,group:"game",style:"separator"}),{state:e,messages:t,dayConsumed:!0};e.army.weak+=T,e.army.normal+=b,e.army.elite+=B,r.population.weak-=T,r.population.normal-=b,r.population.strong-=B,e.player.blood+=w;const{player:ce,leveledUp:J,newLevel:F}=$e(e.player,k);s.state.player=ce;const K=I-Math.abs(w);return t.push(`> [ + ${T} ] residents turned into shovelheads.`),t.push(`> [ + ${b} ] residents bound as ghouls.`),t.push(`> [ + ${B} ] residents risen as revenants.`),t.push({text:`> Infusing the kine with your blood leaves you spent. [ - ${Math.abs(w)} ] BLOOD consumed.`,group:"error"}),K<f.ARMY_RECRUIT_MIN_BLOOD||s.state.player.level>5?t.push({text:`> Essence remaining: [ ${K} ]. The Beast is watchful.`,group:"error"}):K>f.BLOOD_WEALTH_THRESHOLD?t.push({text:`> Your veins are engorged with power. [ ${K} ] Vitae at your command.`,group:"game",style:"warning"}):t.push({text:`> Current Reserves: [ ${K} ] Vitae remains in your veins.`,group:"system"}),t.push({text:`> Successfully recruited ${N} soldiers!`,group:"game"}),t.push(...A.addExp(k)),J?(t.push(...A.newLevel(F,de(F))),t.push({text:"> ======================================",group:"game",style:"warning"})):(t.push({text:"> ======================================",group:"game",style:"creative"}),t.push({text:`> Day passes. ${A.back}`,group:"game",style:"separator"})),{state:e,messages:t,dayConsumed:!0,leveledUp:J,newLevel:F}}function j(s){const{state:e}=s,t=[];return h?(t.push({text:"> ========== SELECT A BRIDE ==========",group:"game",style:"creative"}),t.push({text:"> Exquisite maidens catch your eye...",group:"game",style:"separator"}),h.womenList.forEach((r,a)=>{t.push({text:`> [ ${a+1} ] - ${r.name} ❤ BOND: ${r.recruitCost} BLOOD`,group:"game",style:"title"}),t.push({text:`> - SEDUCTION:${r.bonus.seduction} AGE:${r.age} / ${r.profession}`,group:"game",style:"creative"}),t.push({text:`> - CHARISMA:${r.bonus.charisma} INTELLIGENCE:${r.bonus.intelligence} TACTICS:${r.bonus.tactics}`,group:"system",style:"dim"}),t.push({text:`> - POTENTIAL: SHOVELHEADS (+${r.armyGenerationBonus.weak}) GHOULS (+${r.armyGenerationBonus.normal}) REVENANTS (+${r.armyGenerationBonus.strong})`,group:"system",style:"dim"})}),t.push({text:"> [ 0 ] - Back to village actions",group:"system",style:"title"}),t.push({text:"> ===================================",group:"game",style:"creative"}),{state:e,messages:t,dayConsumed:!1}):{state:e,messages:["> Error: Village session not initialized"],dayConsumed:!1}}function qe(){return h?.villageList||[]}function Z(){return h?.womenList||[]}function Le(){return h&&h.villageList.find(s=>s.id===h.selectedVillageId)||null}function Wt(s){const{state:e}=s,t=[];if(e.player.level<g.LEVEL_UNLOCK_CASTLE)return t.push(`> You are not experienced enough to recruit soldiers! (Requires level ${g.LEVEL_UNLOCK_CASTLE})`),{state:e,messages:t,dayConsumed:!1};const r=10;if(e.player.blood<r)return t.push(`> You don't have enough blood to recruit soldiers! (Need ${r}, have ${e.player.blood})`),{state:e,messages:t,dayConsumed:!1};const a=f.DAILY_BLOOD_UPKEEP_BASE;return e.player.blood-=a,t.push(`> -${a} blood (daily upkeep)`),{state:e,messages:t,dayConsumed:!0,gameOver:e.player.blood<=0}}function ye(s){const e=[];if(!h||h.selectedWomanIndex==null)return{state:s.state,messages:["> Error: No bride selected"],dayConsumed:!1};const t=h.womenList[h.selectedWomanIndex];return e.push({text:"> ======== CHOOSE YOUR CONSORT =========",group:"game",style:"creative"}),e.push({text:`> Take ${t.name} into your service? (Age:${t.age} / ${t.profession})`,group:"game",style:"creative"}),e.push({text:`> A tribute of ${t.recruitCost} BLOOD is required.`,group:"error"}),e.push({text:"> [ 1 ] - Yes. Accept her devotion",group:"system",style:"creative"}),e.push({text:"> [ 2 ] - No. Reject her",group:"system",style:"creative"}),e.push({text:"======================================",group:"system",style:"creative"}),{state:s.state,messages:e,dayConsumed:!1}}const Vt=["Alaric","Alvis","Arnoud","Baldur","Bard","Barrett","Basile","Bastien","Baxter","Benedikt","Blaine","Borus","Bram","Brant","Bruno","Cade","Cain","Caspian","Castor","Cedric","Corvus","Cyrus","Dante","Darius","Daxon","Dimitri","Dorian","Draken","Drexel","Elias","Enoch","Erasmus","Ewan","Fabian","Falco","Fenris","Finnick","Fletcher","Gage","Gideon","Goran","Graves","Griffin","Gunner","Hakon","Harlan","Havelock","Hector","Helmut","Hugo","Ivan","Ivor","Jace","Jasper","Jethro","Kane","Kael","Kasper","Klaus","Konrad","Krieger","Lazarus","Leonid","Loxley","Lucian","Magnus","Malachi","Mordecai","Morten","Nero","Nikolai","Nox","Odin","Orion","Osric","Otto","Pascal","Quillon","Ragnar","Rainer","Rexton","Rocco","Roland","Rufus","Sargon","Seth","Silas","Sloane","Stellan","Talon","Thatcher","Thorne","Torsten","Ulrich","Vane","Vargas","Viktor","Wolfram","Xander","Zane"],Ft=["A disgraced knight who sold his spurs to pay off a gambling debt.","Has a permanent squint from a torch-fire accident in a dungeon.","Refuses to enter a church, claiming the bells make his ears bleed.","Carries a rusted locket containing a lock of hair from a dead saint.","Known for sharpening his blade until it is as thin as a needle.","Always sits with his back to the wall, even in his own home.","Was once a hangman until he realized he preferred protecting life.","Wears a heavy iron gorget to hide a jagged scar across his throat.","Quietly hums funeral dirges during long night watches.","Claims he can smell a liar before they even open their mouth.","Lost a finger in a duel and kept it as a dried memento on a string.","Only sleeps during the day, claiming the sun is the only safe eye.","His armor is mismatched, looted from three different battlefields.","Talks to his sword as if it were his departed younger sister.","Carries a small vial of holy water that he refuses to ever open.","Was kicked out of a monastery for his uncontrollable temper.","Has a tattoo of a weeping eye on the palm of his shield hand.","Always carries a deck of stained cards for a game of chance.","Drinks only watered-down wine to keep his senses sharp.","Spent three years in a pit and now fears the sound of dripping water.","Has a habit of whistling when he senses unseen danger nearby.","Keeps a piece of charcoal in his pocket to mark the doors of enemies.","His cloak is lined with hidden pockets for throwing knives.","Believes he is haunted by the ghost of the first man he killed.","Refuses to look at his own reflection in polished metal.","A giant of a man who avoids stepping on cracks in the stone.","Carries the weight of a blood feud that wiped out his entire village.","Knows thirty different ways to kill a man with a simple belt.","Has eyes as cold as a winter morning in the northern wastes.","Wears a ring with a hidden compartment full of numbing poison.","Never eats food provided by strangers unless they taste it first.","Was a mercenary in the Crusades and came back far too quiet.","Has a collection of teeth taken from fallen foes in a leather pouch.","Fidgets with a silver coin whenever he is nervous or bored.","Claims his grandfather was a wolf-shifter, though few believe him.","Always carries a spare whetstone and a bundle of dry tinder.","His boots are muffled with soft fur for silent patrolling.","Wears a headband to keep sweat and blood out of his eyes.","Suffers from night terrors that make him scream in his sleep.","Is obsessed with keeping his employer's boots perfectly clean.","Learned the art of the bow from a group of forest outlaws.","Will not draw his sword unless he intends to draw blood.","Has a distinctive limp from a mace blow to the hip years ago.","Keeps a small, trained rat in his sleeve to detect poisons.","Wears an eyepatch, though both of his eyes work perfectly fine.","Once survived a week in a collapsed tunnel eating only beetles.",'Is a master of the "iron grip" and can crush a throat bare-handed.',"Always carries a heavy iron key to a house that no longer exists.","Believes that silver is the only metal that can truly kill a demon.","Knows how to navigate by the stars even on the foggiest nights.","Rarely speaks, communicating mostly through grunts and nods.","Has a nose that has been broken so many times it looks like a knot.","Carries a prayer bead for every life he has taken in service.","Refuses to sleep under a roof, preferring the open sky.","Was once a nobleman's son, now reduced to a hired blade.","His shield is scarred with the bite marks of a large beast.","Has a deep, rasping voice like stones grinding together.","Practices his draw a thousand times every single morning.","Heeds the omens found in the flight patterns of crows.","Carries a flask of strong onion juice to wake him from fatigue.","Lost his tongue to a cruel lord and communicates via chalk signs.","His armor smells faintly of lavender to mask the scent of blood.","Can track a man through a crowded market by scent alone.","Is terrified of cats, believing they are spies for the devil.","Wears a heavy bear fur that makes him look twice his size.","Has a habit of checking the structural integrity of every ceiling.",'Uses a mace because he finds swords too "fragile" for real work.',"Carries a small mirror to check around corners and doorways.","Was a galley slave for ten years before escaping during a storm.","Has a secret love for poetry, hidden beneath a gruff exterior.","Will kill anyone who touches his sword without permission.","Believes he can hear the voices of the dead in the wind.","Always tests the weight of a room's furniture for use as weapons.","His family was burned as heretics, leaving him with a hatred for fire.","Has a silver bell tied to his dagger to warn him of its movement.","Never uses a torch, preferring to train his eyes for the dark.","Wears a tunic dyed in the blood of his fallen comrades.","Can sit perfectly still for hours without blinking or moving.","Keeps a clove of garlic in his boot to ward off bad luck.","Was a blacksmith before he realized he was better at using tools.","Carries a heavy crossbow that he named after his mother.","Has a tattoo of a serpent coiling around his sword arm.","Is convinced that the moon influences the speed of his blade.","Drinks bitter herbs to keep himself from falling into a deep sleep.","Always carries a handful of sand to throw in an opponent's eyes.","Wears a cloak made from the banners of a defeated army.","Is a master of the headbutt and the dirty tavern brawl.","Once held a bridge alone against ten men for an hour.","Carries a lockpick hidden inside the hilt of his dagger.","Has a strange obsession with the history of ancient empires.","Is allergic to horses but rides them out of sheer stubbornness.","Claims he was once a prince in a land across the sea.","Has a map of the local sewers tattooed on his torso.","Wears a lucky charm made from a bird's dried skull.","Always pays his debts, whether they are in gold or in blood.","Keeps his face hidden behind a visor or a heavy hood.","Learned to fight in the pits of a distant, southern city.","Refuses to use a shield, calling it a coward's tool.","Has a deep scar on his chest in the shape of a cross.","Is constantly looking at the shadows, waiting for them to move."],Qe=["charisma","tactics","strength"];function Kt(s,e=5){return Array.from({length:e},()=>Xt(s))}function fe(s,e){return Math.floor(Math.random()*(e-s+1))+s}function Ee(s){return s[Math.floor(Math.random()*s.length)]}function Je(s){return s.charisma*.6+s.tactics*.8+s.strength*1.2}function Xt(s){const e=Ee(Qe),t={charisma:0,tactics:0,strength:0};for(const i of Qe){const l=s[i];if(i===e)t[i]=fe(l-10,l+10);else{const u=fe(20,75)/100;t[i]=Math.max(1,Math.floor(l*(1-u)))}}const r=Je(t),a=Math.floor(f.BODYGUARD_MIN_PRICE+r*fe(f.BODYGUARD_PRICE_FACTOR_MIN,f.BODYGUARD_PRICE_FACTOR_MAX)),o=Je(s),n=Math.floor(Math.min(f.BODYGUARD_RECRUIT_CHANCE_MAX,Math.max(f.BODYGUARD_RECRUIT_CHANCE_MIN,o/(o+r)*100)));return{id:crypto.randomUUID(),name:Ee(Vt),description:Ee(Ft),attributes:t,recruitChance:n,price:a,upkeep:Math.floor(a*.15),used:!1,daysInService:0}}function ee(s,e){return Math.floor(Math.random()*(e-s+1))+s}function zt(s){return s[Math.floor(Math.random()*s.length)]}const qt=["charisma","tactics","strength"];function Qt(s,e){const t=[];t.push({text:"> ======================================",group:"game"}),t.push({text:"> =========== DUEL COMMENCES ===========",group:"game"}),t.push({text:"> ======================================",group:"game"});const r=s.charisma*.6+s.tactics*.8+s.strength*1.2,a=e.charisma*.6+e.tactics*.8+e.strength*1.2;let o=Math.floor(r),n=Math.floor(a),i=o,l=n;t.push({text:`> Your Resolve: [ ${o} ]`,group:"game"}),t.push({text:`> Mercenary's Resolve: [ ${n} ]`,group:"error"}),t.push({text:"> ----------- INSTINCT CHECK -----------",group:"error",style:"separator"});let u=Math.random()<.5?"player":"guard";u==="player"?t.push({text:"> 'You seize the moment!",group:"game"}):t.push({text:"> The mercenary acts with blinding speed!",group:"error"}),t.push({text:"> ======================================",group:"game",style:"warning"});let p=0;for(;o>0&&n>0&&p<E.MAX_BODYGUARD_DUEL_ROUNDS;){p++;const _=zt(qt),R=_.charAt(0).toUpperCase()+_.slice(1);t.push({text:`> --- TURN ${p} (${R.toUpperCase()}) ---`,group:"game",style:"warning"});const v=u==="player"?s:e,L=u==="player"?e:s,x=v[_],y=L[_],M=u==="player"?"You":"The mercenary",T=u==="player"?"The mercenary":"You";t.push({text:`> [ ${u==="player"?o+"/"+i:n+"/"+l} ] ${M} attacks with ${R.toUpperCase()} (${x} vs ${y})`,group:u==="player"?"game":"error"});const b=E.BODYGUARD_CHANCE_BASE+(x-y)*E.BODYGUARD_CHANCE_PER_DIFF+ee(E.BODYGUARD_CHANCE_RAND_MIN,E.BODYGUARD_CHANCE_RAND_MAX);if(ee(1,100)<=b){const N=Math.max(E.BODYGUARD_DAMAGE_MIN,Math.floor(x*ee(E.BODYGUARD_DAMAGE_RAND_MIN,E.BODYGUARD_DAMAGE_RAND_MAX)/100));t.push({text:`> HIT! -${N} damage to ${T}`,group:u==="player"?"game":"error"}),u==="player"?n-=N:o-=N}else t.push({text:"> MISS!",group:u==="player"?"game":"error"});u=u==="player"?"guard":"player"}t.push({text:"> ============= DUEL ENDS ==============",group:"game",style:"warning"});let c,d;o<=0||n<=0?(d="killed",c=n<=0?"player":"guard",t.push({text:`> ${c==="player"?"You have slain the mercenary in combat!":"The mercenary has defeated you!"}`,group:c==="player"?"game":"error"})):(d="timeout",o>n?(c="player",t.push({text:"> You outlast the mercenary through exhaustion!",group:"game"})):(c="guard",t.push({text:"> The mercenary endures longer than you!",group:"error"})));const I=c==="player"?ee(15,35):0;return{winner:c,rounds:p,playerHp:Math.max(0,o),guardHp:Math.max(0,n),discountPercent:I,reason:d,log:t}}function Jt(s){const e=[];return e.push({text:"> ============= THE VERDICT ============",group:"system"},{text:`> ROUNDS PLAYED: ${s.rounds}`,group:"system"}),s.reason==="timeout"&&e.push({text:"> The struggle ceases as strength wanes.",group:"system"}),e.push({text:"> --------------------------------------",group:"system",style:"separator"},{text:`> Your Resolve: [ ${s.playerHp} ]`,group:"game"},{text:`> Mercenary's Resolve: [ ${s.guardHp} ]`,group:"error"},{text:"> --------------------------------------",group:"system",style:"separator"}),s.winner==="player"?e.push({text:"> You have proven your dominance.",group:"game"},{text:"> The mercenary agrees to serve you.",group:"game"},{text:`> Blood Tribute reduced by ${s.discountPercent}% due to your might.`,group:"game"}):e.push({text:"> You failed to impress the mercenary.",group:"error"},{text:"> You pay the full price.",group:"error"}),e.push({text:"> ======================================",group:"system"}),[...e]}function je(s){const e=Math.floor(s.price*f.BODYGUARD_DUTY_PERCENT);return s.price+e}const G={guards:[]};function Ae(s,e){if(s.player.level<g.LEVEL_UNLOCK_BODYGUARD)return[{text:"> Bodyguards are not available yet.",group:"system"}];if(!e){(G.cachedDay!==s.world.currentDay||G.guards.length===0)&&(G.guards=Kt(s.player.stats),G.cachedDay=s.world.currentDay);const i=[{text:"> ======================================",group:"system"},{text:"> ======== AVAILABLE BODYGUARDS ========",group:"system"},{text:"> ======================================",group:"system"}];return G.guards.forEach((l,u)=>{const p=je(l);i.push({text:`> [ ${u+1} ] - ${l.name} ' PRICE: ${p} BLOOD`,group:"system"},{text:`> ${l.description}`,group:"system",style:"creative"},{text:`> CHARISMA: [ ${l.attributes.charisma} ] ' TACTICS: [ ${l.attributes.tactics} ] ' STRENGTH: [ ${l.attributes.strength} ]`,group:"system",style:"creative"},{text:`> RECRUIT CHANCE: ${l.recruitChance}%`,group:"system",style:"creative"})}),i.push({text:"> [ 0 ] - Back",group:"system"}),i}const t=Number(e)-1,r=G.guards[t];if(!r)return[{text:"Invalid choice.",group:"system"}];if(s.player.blood<r.price){const i=je(r);return[{text:`> Not enough BLOOD to hire ${r.name}.`,group:"error"},{text:`> Required: ${i} | You have: ${s.player.blood}`,group:"system"},{text:"> Choose another mercenary or earn more blood.",group:"system"}]}const a=Qt({charisma:s.player.stats.charisma,tactics:s.player.stats.tactics,strength:s.player.stats.strength},r.attributes);let o=r.price;if(a.winner==="player"&&(o-=Math.floor(r.price*(a.discountPercent/100))),s.player.blood-=o,a.winner==="player"){s.companions.bodyguards=[{...r,used:!1,daysInService:0}],s.statistics.changedBodyguards++;const i=Math.floor(s.player.blood*f.BODYGUARD_DUTY_PERCENT);s.player.blood-=i,G.guards=[]}const n=Jt(a);if(a.winner==="player"){const i=Math.floor(s.player.blood*f.BODYGUARD_DUTY_PERCENT);s.player.blood=Math.max(0,s.player.blood-i),n.push({text:`> GUARDIAN'S TOLL: -${i} BLOOD`,group:"error"}),n.push({text:"> --------------------------------------",group:"error"})}return[...a.log,...n]}let S=null;function z(s){const{state:e}=s;return e.player.attributePointsAvailable<=0?{state:e,messages:["> No attribute points available"],dayConsumed:!1}:(S={pointsRemaining:e.player.attributePointsAvailable,pointsDistributed:0,hpGuaranteedUsed:!1},le(s))}function le(s){const{state:e}=s,t=[];if(!S)return{state:e,messages:["> Error: Upgrade session not initialized"],dayConsumed:!1};if(S.pointsRemaining<=0)return t.push("> ======== ATTRIBUTES UPGRADED ========="),t.push({text:"> All attribute points have been distributed!",group:"game",style:"warning"}),t.push("> You feel stronger... the day passes."),t.push({text:"> ======================================",group:"system"}),S=null,{state:e,messages:t,dayConsumed:!0,gameOver:!1};t.push("> ==== CHOOSE ATTRIBUTE TO UPGRADE ===="),t.push(`> Points remaining: ${S.pointsRemaining}/${S.pointsRemaining+S.pointsDistributed}`);const r=[{id:"maxHp",label:`HP (${e.player.stats.maxHp})`},{id:"strength",label:`STRENGTH (${e.player.stats.strength})`},{id:"speed",label:`SPEED (${e.player.stats.speed})`},{id:"charisma",label:`CHARISMA (${e.player.stats.charisma})`},{id:"intelligence",label:`INTELLIGENCE (${e.player.stats.intelligence})`},{id:"tactics",label:`TACTICS (${e.player.stats.tactics})`}],a=He("ATTRIBUTE UPGRADE","Choose an attribute to upgrade:",r,["[ 0 ] - Auto upgrade"]),o=new V(a);return t.push(...o.render()),{state:e,messages:t,dayConsumed:!1}}function jt(s){const{state:e,attributeId:t}=s,r=[];if(!S||S.pointsRemaining<=0)return{state:e,messages:["> No points available"],dayConsumed:!1};if(!["maxHp","strength","speed","charisma","intelligence","tactics"].includes(t))return r.push(`> Invalid attribute: ${t}`),le({state:e});const o=t==="maxHp"?5:1;if(e.player.stats[t]+=o,S.pointsRemaining-=1,S.pointsDistributed+=1,r.push(`> +${o} ${t.toUpperCase()}`),r.push(""),S.pointsRemaining>0){const n=le({state:e});return{...n,messages:[...r,...n.messages]}}else return r.push({text:"> ======== ATTRIBUTES UPGRADED ========",group:"system"}),r.push({text:"> All attribute points have been distributed!",group:"game",style:"warning"}),r.push({text:"> You feel stronger... the day passes.",group:"system"}),r.push({text:"> ======================================",group:"system"}),e.player.attributePointsAvailable=0,S=null,{state:e,messages:r,dayConsumed:!0,gameOver:!1}}function Zt(s){const e=[];if(!S||S.pointsRemaining<=0)return e;const t=["maxHp","strength","speed","charisma","intelligence","tactics"];for(e.push({text:"> ======== AUTO-UPGRADE STARTED ========",group:"system"}),!S.hpGuaranteedUsed&&S.pointsRemaining>0&&(s.player.stats.maxHp+=5,S.pointsRemaining-=1,S.pointsDistributed+=1,S.hpGuaranteedUsed=!0,e.push("> +5 MAXHP"));S.pointsRemaining>0;){const r=t[Math.floor(Math.random()*t.length)],a=r==="maxHp"?5:1;s.player.stats[r]+=a,S.pointsRemaining-=1,S.pointsDistributed+=1,e.push(`> +${a} ${r.toUpperCase()}`)}return e}function Rt(s){const{state:e,choice:t}=s,r=[];if(!S)return{state:e,messages:["> Error: Upgrade session not initialized"],dayConsumed:!1};if(t===0)return r.push(...Zt(e)),r.push(""),r.push({text:"> ======== ATTRIBUTES UPGRADED ========",group:"system"}),r.push({text:"> All attribute points have been distributed!",group:"game",style:"warning"}),r.push({text:"> You feel stronger... the day passes.",group:"system"}),r.push({text:"> ======================================",group:"system"}),e.player.attributePointsAvailable=0,S=null,{state:e,messages:r,dayConsumed:!0,gameOver:!1};const o={1:"maxHp",2:"strength",3:"speed",4:"charisma",5:"intelligence",6:"tactics"}[t];if(!o){r.push(`> Invalid choice: ${t}`);const n=le({state:e});return{...n,messages:[...r,...n.messages]}}return jt({state:e,attributeId:o})}function Ze(){S=null}function es(s){return s.reduce((e,t)=>({intelligence:e.intelligence+(t.bonus.intelligence??0),charisma:e.charisma+(t.bonus.charisma??0),tactics:e.tactics+(t.bonus.tactics??0),seduction:e.seduction+(t.bonus.seduction??0)}),{intelligence:0,charisma:0,tactics:0,seduction:0})}function St(s){const e=es(s.companions.wives);return{maxHp:s.player.stats.maxHp,strength:s.player.stats.strength,speed:s.player.stats.speed,seduction:s.player.stats.seduction+e.seduction,charisma:s.player.stats.charisma+e.charisma,intelligence:s.player.stats.intelligence+e.intelligence,tactics:s.player.stats.tactics+e.tactics}}function _t(s){return s.bonus.charisma*1.2+s.bonus.intelligence*1.1+s.bonus.tactics*1}function ts(s){return{percent:.15,costMultiplier:.15+_t(s)*.001}}function ss(s,e,t=0){const r=Math.random(),a=s/(s+e);return{success:r<a+t,roll:r,threshold:a}}function rs(s,e){let t=E.WIFEDUEL_ALL_MIN_DAMAGE_MIN,r=E.WIFEDUEL_ALL_MIN_DAMAGE_MAX;if(s>=10){const a=.12+Math.random()*.08;return Math.max(1,Math.floor(e*a))}return Math.floor(t+Math.random()*(r-t+s*.15))}function as(s){const e=[],t=s.playerBase,r=s.womanBase,a=s.playerRoundStat*(.25+Math.random()*.75),o=s.womanRoundStat*(.25+Math.random()*.75);let n=Math.floor(t+a),i=Math.floor(r+o);const l=n,u=i;s.round===1?e.push({text:`> --- ROUND ${s.round} (${s.stat.toUpperCase()}) THE BATTLE OF PRESENCE ---`,group:"game",style:"warning"}):s.round===2?e.push({text:`> --- ROUND ${s.round} (${s.stat.toUpperCase()}) THE COLD CALCULATION ---`,group:"game",style:"warning"}):e.push({text:`> --- ROUND ${s.round} (${s.stat.toUpperCase()}) THE MENTAL SIEGE ---`,group:"game",style:"warning"}),e.push({text:`> Your HP: ${l}`,group:"system"}),e.push({text:`> ${s.womanName}'s HP: ${u}`,group:"system"});const p=s.playerCharisma>s.womanCharisma?"player":"woman";p==="player"?(e.push({text:`> Your aura overwhelms her (The Fates cast:${s.playerCharisma}).`,group:"game"}),e.push({text:"> --------------------------------------",group:"game"})):(e.push({text:`> ${s.womanName} dominates the air (The Fates cast:${s.womanCharisma}).`,group:"error"}),e.push({text:"> --------------------------------------",group:"error"}));let c=p,d=0;const I=E.MAX_WIFE_DUEL_ROUNDS;for(;n>0&&i>0&&d<I;){d++;const R=c==="player"?s.playerRoundStat:s.womanRoundStat,v=c==="player"?s.womanRoundStat:s.playerRoundStat,L=c==="player"?s.bonusChance:0;if(ss(R,v,L).success){const y=rs(R,c==="player"?u:l);c==="player"?(i=Math.max(0,i-y),s.round===1?e.push({text:`> [${n}/${l}] Your supernatural allure pierces her heart! ${s.womanName}: (-${y} Resolve.)`,group:"game"}):s.round===2?e.push({text:`> [${n}/${l}] You corner her with flawless etiquette and pressure! ${s.womanName}: (-${y} Resolve.)`,group:"game"}):e.push({text:`> [${n}/${l}] Your razor-sharp wit shatters her logical defenses! ${s.womanName}: (-${y} Resolve.)`,group:"game"})):(n=Math.max(0,n-y),s.round===1?e.push({text:`> [${i}/${u}] ${s.womanName}'s icy stare makes your confidence flicker. You: (-${y} Resolve.)`,group:"error"}):s.round===2?e.push({text:`> [${i}/${u}] ${s.womanName} exploits a flaw in your social standing. You: (-${y} Resolve.)`,group:"error"}):e.push({text:`> [${i}/${u}] ${s.womanName} sees through your deception. Your mind reels. You: (-${y} Resolve.)`,group:"error"}))}else c==="player"?s.round===1?e.push({text:`> [${n}/${l}] (FAIL!) Your charm fails to impress her; she looks away.`,group:"game"}):s.round===2?e.push({text:`> [${n}/${l}] (FAIL!) Your tactical maneuvering leads to a stalemate.`,group:"game"}):e.push({text:`> [${n}/${l}] (FAIL!) Your words are too complex; she simply doesn't listen.`,group:"game"}):s.round===1?e.push({text:`> [${i}/${u}] ${s.womanName}. (FAIL!) You remain unmoved by her attempts to ignore you.`,group:"error"}):s.round===2?e.push({text:`> [${i}/${u}] ${s.womanName}. (FAIL!) She tries to outmaneuver you, but you anticipate her move.`,group:"error"}):e.push({text:`> [${i}/${u}] ${s.womanName}. (FAIL!) Her arguments fall apart before your superior intellect.`,group:"error"});c=c==="player"?"woman":"player"}const _=i<=0;return _?s.round===1?e.push({text:`> ROUND VICTORY! ${s.womanName} is spellbound by your gaze. Her heart betrays her.`,group:"game"}):s.round===2?e.push({text:"> ROUND VICTORY! You have dismantled her status. She finds no more room to retreat.",group:"game"}):e.push({text:"> ROUND VICTORY! Your words have left her mind in tatters. Logic gives way to your will.",group:"game"}):s.round===1?e.push({text:`> ROUND LOST! ${s.womanName} looks through you as if you were mere glass. You feel insignificant.`,group:"error"}):s.round===2?e.push({text:`> ROUND LOST! ${s.womanName} outmaneuvers your advances. You are the one who is trapped.`,group:"error"}):e.push({text:`> ROUND LOST! ${s.womanName} exposes the cracks in your facade. Your mental grip shatters.`,group:"error"}),e.push({text:`> --- END ROUND ${s.round} ---`,group:"game",style:"warning"}),{playerWon:_,log:e}}function os(s,e){if(s<1e4)return 0;const t=_t(e);return(1-Math.min(t/30,1))*(.01+Math.random()*.24)}function W(s){const{state:e,woman:t,bonusOverride:r}=s,a=[];if(!h)return{state:e,messages:["> Error: No session"],dayConsumed:!1};const o=St(e),n=t.bonus,i=o.seduction+Math.floor(e.player.level*.4),l=n.seduction,u=o.charisma,p=n.charisma;(!h.seductionState||h.seductionState.womanId!==t.id)&&(h.seductionState={currentRound:1,playerWins:0,womanWins:0,womanId:t.id,bonusChance:r?.15:0});let c=h.seductionState.playerWins,d=h.seductionState.womanWins,I=h.seductionState.currentRound,_=h.seductionState.bonusChance;const R=os(e.player.blood,t);r&&(_=Math.max(_,.15)),_=Math.min(_+R,.86),h.seductionState.bonusChance=_,a.push({text:"> ======= ENTHRALLMENT COMMENCES =======",group:"game",style:"creative"}),a.push({text:`> Bending ${t.name} to your will (Seduction: ${l})`,group:"game",style:"creative"});const v={1:"charisma",2:"tactics",3:"intelligence"};for(let y=I;y<=3;y++){const M=v[y],T=o[M],b=n[M],B={round:y,stat:M,playerBase:i,womanBase:l,playerRoundStat:T,womanRoundStat:b,bonusChance:_,womanName:t.name,playerCharisma:u,womanCharisma:p},N=as(B);a.push(...N.log),N.playerWon?c++:d++,h.seductionState.playerWins=c,h.seductionState.womanWins=d,h.seductionState.currentRound=y+1;const U=ts(t);let k=Math.floor(t.recruitCost*U.costMultiplier);const w=Math.floor(U.percent*100);if(y<3&&(c===d||y===1))return h.pendingSeductionBoost={round:y,womanId:t.id,cost:k},a.push({text:"> =========== THE TEMPTATION ===========",group:"game",style:"warning"}),a.push({text:`> Intoxicate ${t.name} with a display of wealth?`,group:"game",style:"warning"}),a.push({text:`> EFFECT: +${w}% FOCUS`,group:"game",style:"warning"}),a.push({text:`> COST: ${k} BLOOD`,group:"error"}),a.push({text:`> You have: ${e.player.blood} BLOOD`,group:"system"}),a.push({text:"> [1] - Yes. Bribe her senses",group:"system",style:"creative"}),a.push({text:"> [2] - No. Trust your natural allure",group:"system",style:"creative"}),a.push({text:"> ======================================",group:"system",style:"warning"}),{state:e,messages:a,dayConsumed:!1};if(c>=2||d>=2)break}const L=t.recruitCost;let x=L;return c>=2?(x=Math.floor(L*f.WIFE_RECRUIT_DISCOUNT),e.companions.wives.push({id:t.id,name:t.name,age:t.age,profession:t.profession,bonus:t.bonus,armyGeneration:{weak:t.armyGenerationBonus.weak,normal:t.armyGenerationBonus.normal,elite:t.armyGenerationBonus.strong},daysTogether:0}),a.push({text:"> ======================================",group:"game"}),a.push({text:"> ============== SUCCESS ===============",group:"game"}),a.push({text:"> ======================================",group:"game"}),a.push({text:`> ${t.name} is yours! She is bound by your Vitae. BLOOD [ -${x} ] (20% Grace)`,group:"game"}),a.push({text:"> ======================================",group:"game"})):(a.push({text:"> ======================================",group:"error"}),a.push({text:"> ============== FAILURE ===============",group:"error"}),a.push({text:"> ======================================",group:"error"}),a.push({text:`> FAILURE: ${t.name} resisted. You exhausted your power for nothing. BLOOD [ -${x} ] (You pay full)`,group:"error"}),a.push({text:"> ======================================",group:"error"})),e.player.blood=Math.max(0,e.player.blood-x),a.push({text:`> Day passes. ${A.back[0]}`,group:"game",style:"separator"}),h.seductionState=void 0,h.pendingSeductionBoost=void 0,{state:e,messages:a,dayConsumed:!0,gameOver:e.player.blood<=0}}function et(s,e){if(!h?.pendingSeductionBoost)return{state:e,messages:["> Error: No seduction boost context"],dayConsumed:!1};const{womanId:t}=h.pendingSeductionBoost,r=h.womenList.find(a=>a.id===t);if(!r)return h.pendingSeductionBoost=void 0,{state:e,messages:["> Error: Bride not found"],dayConsumed:!1};if(s==="1"){const a=h.pendingSeductionBoost;if(!a)return{state:e,messages:["> Error: Boost lost"],dayConsumed:!1};const o=a.cost,n=o+r.recruitCost;if(e.player.blood<n){h.pendingSeductionBoost=void 0;const i=W({state:e,woman:r,guardLevel:e.world.activeGuardLevel??1,bonusOverride:!1});return{state:i.state,messages:[{text:"> ======== YOUR BLOOD RUNS THIN ========",group:"error"},{text:`> Caution: including the tribute, your veins must hold at least [ ${n} BLOOD ] to survive the night.`,group:"error"},{text:"> You must rely on your natural allure.",group:"error"},...i.messages],dayConsumed:i.dayConsumed}}return e.player.blood-=o,h.pendingSeductionBoost=void 0,W({state:e,woman:r,guardLevel:e.world.activeGuardLevel??1,bonusOverride:!0})}return s==="2"?(h.pendingSeductionBoost=void 0,W({state:e,woman:r,guardLevel:e.world.activeGuardLevel??1})):{state:e,messages:[{text:`> INVALID CHOICE "${s}"`,group:"error"}],dayConsumed:!1}}class ns{menuContext={state:"select",selectedVillageIndex:-1};handleCommand(e,t){if(h?.pendingSeductionBoost)return et(e,t);if(e==="village_start")return this.menuContext.state="select",{...oe({state:t}),nextState:"ACTION_MENU"};const r=Number(e);switch(this.menuContext.state){case"seduction_boost":const a=Number(e);if(!Number.isInteger(a)||a<1||a>2)return e==="ex"||e==="exit"||e==="0"?this.handleBack(t):{state:t,messages:[{text:`> Invalid choice: "${e}"`,group:"error"},...this.renderCurrentMenu(t)],dayConsumed:!1,nextState:"ACTION_MENU"};const o=et(e,t);return{...o,nextState:o.dayConsumed?"LOBBY":"ACTION_MENU"};case"select":return r===0||e==="ex"||e==="exit"?this.handleBack(t):this.handleVillageSelection(r,t);case"main":return r===0||e==="ex"||e==="exit"?this.handleBack(t):this.handleMainMenuChoice(r,t);case"recruit":return r===0||e==="ex"||e==="exit"?this.handleBack(t):this.handleRecruitSelection(r,t);case"attack":return r===0||e==="ex"||e==="exit"?this.handleBack(t):this.handleAttackSelection(r,t);case"wife":if(r===0||e==="ex"||e==="exit")return this.handleBack(t);const n=this.handleWifeSelection(r,t);return n.nextState==="WIFE_CONFIRM"&&(this.menuContext.state="wife_confirm"),n;case"wife_confirm":return r===1||e==="1"?this.confirmWifeHire(t):r===2||e==="2"?(this.menuContext.state="wife",j({state:t})):{state:t,messages:["> Invalid"],dayConsumed:!1};case"bodyguard":return r===0||e==="ex"||e==="exit"?this.handleBack(t):this.handleBodyguardList(r,t);case"bodyguard_confirm":return r===0||e==="ex"||e==="exit"?this.handleBack(t):this.handleBodyguardConfirm(r,t);case"attribute_upgrade":return!Number.isInteger(r)||r<0?e==="ex"||e==="exit"?this.handleBack(t):{state:t,messages:[{text:`> Invalid choice: "${e}"`,group:"error"},...this.renderCurrentMenu(t)],dayConsumed:!1,nextState:"ATTRIBUTE_UPGRADE"}:this.handleAttributeUpgrade(r,t);default:return{state:t,messages:[{text:"> ERROR: Unknown menu state",group:"error"}],dayConsumed:!1,nextState:"LOBBY"}}}handleVillageSelection(e,t){const r=qe();return e<1||e>r.length?{state:t,messages:[{text:`Invalid choice: ${e}`,group:"error"},...this.renderCurrentMenu(t)],dayConsumed:!1,nextState:"ACTION_MENU"}:(this.menuContext.selectedVillageIndex=e-1,this.menuContext.state="main",{...$({state:t,villageIndex:this.menuContext.selectedVillageIndex}),nextState:"ACTION_MENU"})}handleMainMenuChoice(e,t){switch(e){case 1:const r=At({state:t});if(r.leveledUp){this.menuContext.state="attribute_upgrade";const l=z({state:r.state});return{state:l.state,messages:[...r.messages,...l.messages],dayConsumed:r.dayConsumed,nextState:"ATTRIBUTE_UPGRADE"}}return{...r,dayConsumed:!!r.dayConsumed,nextState:r.dayConsumed?"LOBBY":"ACTION_MENU"};case 2:this.menuContext.state="attack";const a=He("ATTACK THE GUARD","Choose an action:",$t(),["[ 0 ] - Back"]),o=new V(a);return{state:t,messages:o.render(),dayConsumed:!1,nextState:"ACTION_MENU"};case 3:return t.player.level<g.LEVEL_UNLOCK_WIFE?{state:t,messages:[`> Wives available at level ${g.LEVEL_UNLOCK_WIFE}`,...this.renderCurrentMenu(t)],dayConsumed:!1,nextState:"ACTION_MENU"}:(this.menuContext.state="wife",{...j({state:t}),nextState:"ACTION_MENU"});case 4:if(t.companions.bodyguards.length>0)return{state:t,messages:[{text:"======================================",group:"system",style:"separator"},{text:"You already have a bodyguard in service.",group:"error"},{text:"Only one personal bodyguard is allowed at a time.",group:"system"},{text:"Dismiss the current one first if you wish to recruit another.",group:"system"},{text:"======================================",group:"system",style:"separator"},...$({state:t,villageIndex:this.menuContext.selectedVillageIndex}).messages],dayConsumed:!1,nextState:"ACTION_MENU"};this.menuContext.state="bodyguard";const i=Ae(t);return{state:t,messages:i,dayConsumed:!1,nextState:"ACTION_MENU"};default:return{state:t,messages:[{text:`> Invalid choice: ${e}`,group:"error"},...this.renderCurrentMenu(t)],dayConsumed:!1,nextState:"ACTION_MENU"}}}handleRecruitSelection(e,t){const a=qe().length+1;return e<1||e>a?{state:t,messages:[{text:`> Invalid choice: ${e}`,group:"error"},...this.renderCurrentMenu(t)],dayConsumed:!1,nextState:"ACTION_MENU"}:e===a?(this.menuContext.state="main",{...$({state:t,villageIndex:this.menuContext.selectedVillageIndex}),nextState:"ACTION_MENU"}):{...Wt({state:t}),nextState:"LOBBY"}}handleAttackSelection(e,t){if(!Le())return{state:t,messages:["> Error: Village not selected"],dayConsumed:!1,nextState:"LOBBY"};switch(e){case 1:const a=be({state:t}),o=[...a.messages];if(a.leveledUp){this.menuContext.state="attribute_upgrade";const i=z({state:a.state});return{state:i.state,messages:[...o,"",...i.messages],dayConsumed:a.dayConsumed,nextState:"ATTRIBUTE_UPGRADE"}}return this.menuContext.state="main",{...a,nextState:"LOBBY"};case 2:return this.menuContext.state="main",{...$({state:t,villageIndex:this.menuContext.selectedVillageIndex}),nextState:"ACTION_MENU"};default:return{state:t,messages:[{text:`> Invalid choice: ${e}`,group:"error"},...this.renderCurrentMenu(t)],dayConsumed:!1,nextState:"ACTION_MENU"}}}handleWifeSelection(e,t){const r=Z(),a=r.length+1;if(e<1||e>a)return{state:t,messages:[{text:`> Invalid choice: ${e}`,group:"error"},...this.renderCurrentMenu(t)],dayConsumed:!1,nextState:"ACTION_MENU"};if(e===a)return this.menuContext.state="main",{...$({state:t,villageIndex:this.menuContext.selectedVillageIndex}),nextState:"ACTION_MENU"};const o=e-1;if(o>=0&&o<r.length){if(!h)return{state:t,messages:[{text:"> Error: Session not initialized",group:"error"}],dayConsumed:!1,nextState:"ACTION_MENU"};if(t.companions.wives.length>=g.WIVES_MAX){const i=Z()[o];return{state:t,messages:[{text:"> ============== ,(T,_,T), =============",group:"system",style:"separator"},{text:"> ====== YOUR DOMINION HAS PEAKED ======",group:"system",style:"separator"},{text:`> Oh, ${i.name}...`,group:"system",style:"separator"},{text:`> Even an Elder cannot bind more than ${g.WIVES_MAX} consorts.`,group:"error",style:"warning"},{text:"> To take another would shatter your control and drain your essence dry.",group:"system",style:"warning"},{text:"> ======================================",group:"system",style:"separator"},...j({state:t}).messages],dayConsumed:!1,nextState:"ACTION_MENU"}}return h.selectedWomanIndex=o,this.menuContext.state="wife_confirm",{...ye({state:t}),nextState:"WIFE_CONFIRM"}}return ye({state:t})}confirmWifeHire(e){if(!h||h.selectedWomanIndex==null)return{state:e,messages:["> Error: No woman selected"],dayConsumed:!1,nextState:void 0};const t=Z()[h.selectedWomanIndex],r=Le();if(!r)return{state:e,messages:["> Error: No village selected"],dayConsumed:!1,nextState:void 0};const a=[];if(e.player.blood<t.recruitCost)return{state:e,messages:[{text:"> ======================================",group:"system",style:"separator"},{text:"> ============== ,(-,_,-), =============",group:"system",style:"separator"},{text:"> The Hunger prevents this...",group:"error"},{text:`> Cost: [ ${t.recruitCost} ]`,group:"error"},{text:`> Current BLOOD: [ ${e.player.blood} ]`,group:"system"},{text:"> ======================================",group:"system",style:"separator"},...ye({state:e}).messages],dayConsumed:!1,nextState:"WIFE_CONFIRM"};const o=Et(r.guardLevel);if(Math.random()<o){const i=be({state:e,silentDayEnd:!0});if(a.push(...i.messages),i.gameOver)return{...i,messages:a,nextState:void 0};if(i.leveledUp)return h.pendingWifeHire={womanId:t.id,guardLevel:r.guardLevel,selectedWomanIndex:h.selectedWomanIndex},this.enterAttributeUpgradeMode(i.state);const l=W({state:i.state,woman:t,guardLevel:r.guardLevel});return a.push(...l.messages),this.menuContext.state="main",{...l,messages:a,nextState:l.dayConsumed?"LOBBY":"ACTION_MENU"}}const n=W({state:e,woman:t,guardLevel:r.guardLevel});return a.push(...n.messages),this.menuContext.state="main",{...n,messages:a,nextState:n.dayConsumed?"LOBBY":"ACTION_MENU"}}handleBodyguardList(e,t){return e===0?this.handleBack(t):(this.menuContext.selectedGuardIndex=e-1,this.menuContext.state="bodyguard_confirm",this.showBodyguardConfirm(t))}showBodyguardConfirm(e){if(this.menuContext.selectedGuardIndex===void 0)return{state:e,messages:["Error: No bodyguard selected"],dayConsumed:!1,nextState:"ACTION_MENU"};const t=G.guards[this.menuContext.selectedGuardIndex];if(!t)return{state:e,messages:["Error: Invalid bodyguard selection"],dayConsumed:!1,nextState:"ACTION_MENU"};const r=[{text:"> ======== CLAIM YOUR SENTINEL =========",group:"system",style:"creative"},{text:`> Bind this protector to your shadow for ${t.price} BLOOD?`,group:"system",style:"creative"},{text:`> Remaining Potency: ${e.player.blood} BLOOD.`,group:"system",style:"creative"},{text:"> [ 1 ] - Yes. Seal the pact",group:"system",style:"creative"},{text:"> [ 2 ] - No. Decline",group:"system",style:"creative"}];return{state:e,messages:r,dayConsumed:!1,nextState:"ACTION_MENU"}}handleBodyguardConfirm(e,t){if(this.menuContext.selectedGuardIndex===void 0)return{state:t,messages:["Error: No bodyguard selected"],dayConsumed:!1,nextState:"ACTION_MENU"};switch(e){case 1:const r=(this.menuContext.selectedGuardIndex+1).toString(),a=Ae(t,r);return this.menuContext.state="main",{state:t,messages:a,dayConsumed:!0,nextState:"LOBBY"};case 2:this.menuContext.state="bodyguard";const o=Ae(t);return{state:t,messages:o,dayConsumed:!1,nextState:"ACTION_MENU"};default:return{state:t,messages:[{text:`Invalid choice: ${e}`,group:"error"},...this.showBodyguardConfirm(t).messages],dayConsumed:!1,nextState:"ACTION_MENU"}}}handleBack(e){return this.menuContext.state==="select"?(this.reset(),{state:e,messages:[`> ${A.back}`],dayConsumed:!1,nextState:"LOBBY"}):this.menuContext.state==="main"?(this.menuContext.state="select",{...oe({state:e}),nextState:"ACTION_MENU"}):(this.menuContext.state="main",{...$({state:e,villageIndex:this.menuContext.selectedVillageIndex}),nextState:"ACTION_MENU"})}renderCurrentMenu(e){return this.getMenuContent(e).messages}getMenuContent(e){switch(this.menuContext.state){case"select":return oe({state:e});case"main":return $({state:e,villageIndex:this.menuContext.selectedVillageIndex});case"recruit":return Pt({state:e});case"wife":return j({state:e});case"attribute_upgrade":return z({state:e});default:return{state:e,messages:["> ERROR"],dayConsumed:!1}}}handleAttributeUpgrade(e,t){const r=Rt({state:t,choice:e});if(r.dayConsumed){if(h?.pendingWifeHire){const a=Z()[h.pendingWifeHire.selectedWomanIndex];return h.pendingWifeHire.guardLevel,h.pendingWifeHire=void 0,{...W({state:r.state,woman:a}),nextState:"LOBBY"}}return this.menuContext.state="select",Ze(),{...r,nextState:"LOBBY"}}return{...r,nextState:"ATTRIBUTE_UPGRADE"}}enterAttributeUpgradeMode(e){return this.menuContext.state="attribute_upgrade",{...z({state:e}),nextState:"ATTRIBUTE_UPGRADE"}}reset(){this.menuContext={state:"select",selectedVillageIndex:-1},Ze()}getState(){return{...this.menuContext}}}const is=["Ulfric","Wolfgang","Rodulf","Beowulf","Arnulf","Bardulf","Udolf","Randolf","Adalwolf","Cynewulf","Geirolf","Ingolf","Landulf","Ormulf","Thorulf","Wulfstan","Sigewulf","Eadwulf","Hrodwulf","Vidolf","Vukan","Vukmir","Zevlak","Volos","Yaropolk","Borislav","Dragomir","Lyutost","Vron","Volkh","Radolf","Veles","Gromov","Moroz","Svyatopolk","Ognen","Chernobog","Belobog","Stribog","Vourdalak","Lupus Rex","Vorax","Sanguis","Ferox","Nocturnus","Malphas","Valerius","Tiberius","Nero the Beast","Claudius Fang","Magnus Wolf","Septimus","Aurelius","Lucius Gale","Vesper","Aethelred","Constantine","Dominus","Silvester","Ursaen","Korgar","Zarkov","Varag","Morak","Thraka","Grul","Vorne","Draug","Skarn","Razgar","Morg","Horg","Varkas","Braker","Gnash","Kruger","Vorn","Zorn","Vulg","Grimm","Blood-Drinker","Moon-Eater","Grave-Digger","Rib-Cracker","Night-Stalker","Flesh-Tearer","Bone-Biter","Silver-Hater","Heart-Ripper","Shadow-Howl","The Beast of Gévaudan","The Black Shuck","Barghest","Rougarou","Amarok","Malar","Carcharoth","Draugluin","Maugrim","Gmork","The Alpha Prime","Moon-Scar","Iron-Jaw","Red-Eye","The Great Grey","Storm-Howler","Void-Leaper","Crag-Lord","Pale-Stalker","The Eternal Hunger"],tt={data:[{name:"Dreadspire Hold",description:"A towering obsidian fortress that seems to drink the light of the moon."},{name:"Bloodthrone Manor",description:"An elegant but decaying estate where the fountains flow with ancient, clotted blood."},{name:"Graveguard Citadel",description:"Built atop a mountain of nameless bones, its walls are reinforced with enchanted lead."},{name:"Ironfang Keep",description:"A jagged fortress with portcullises that resemble the teeth of a gargantuan beast."},{name:"Shadowfell Palace",description:"A castle that partially exists in the spirit realm; its towers flicker in and out of sight."},{name:"Mournhall Castle",description:"The weeping stones of this keep constantly leak a cold, salty mist."},{name:"Crimson Bastion",description:"Red marble walls make this fortress look like it was carved from a single giant heart."},{name:"Nightshroud Abbey",description:"A former holy site, now home to a coven of vampires who pray to the darkness."},{name:"Ravenloft Spire",description:"A needle-thin tower where thousands of ravens keep watch for their immortal master."},{name:"Voidwatch Fortress",description:"Built on the edge of a literal hole in reality, overlooking the Great Nothing."},{name:"Silverbane Estate",description:"The only castle in the lands with walls coated in silver, meant to keep *something* inside."},{name:"Mistwalker Manor",description:"A house that moves through the woods on legs of thick, magical fog."},{name:"Ebonheart Castle",description:"At the center of this keep lies a black stone that pulses with a rhythmic thrum."},{name:"Bleakfrost Keep",description:"Encased in ice that never melts, even in the hottest summer."},{name:"Sanguine Reach",description:"A coastal fortress with docks designed for ships that carry living cargo."},{name:"Hollowpeak Citadel",description:"Carved directly into the interior of an extinct, hollowed-out volcano."},{name:"Wraithlight Manor",description:"The windows glow with a sickly green fire that requires no wood or oil."},{name:"Stonegrip Fortress",description:"The statues on the battlements are said to be former invaders turned to stone."},{name:"Pale Rose Castle",description:"Surrounded by a labyrinth of white roses that drain the color from anyone who touches them."},{name:"The Silent Bastion",description:"A spell keeps this castle in absolute silence; even a scream makes no sound."},{name:"Cruelwater Keep",description:"Built on stilts over a lake of acid that protects the lord from the peasant revolts."},{name:"Omen Spire",description:"Lightning strikes the central lightning rod of this tower every hour, day and night."},{name:"Blackwood Hall",description:"A manor built from wood so dark and hard it is often mistaken for iron."},{name:"Gloomstone Priory",description:"A dark monastery where the monks traded their souls for eternal night."},{name:"Sorrow's  Gate",description:"The entrance is a massive archway made from the fused armor of fallen knights."},{name:"Ashenvale Castle",description:"Everything here is covered in a layer of grey ash from a nearby eternal fire."},{name:"Dracul's  Rest",description:"A legendary retreat hidden behind a waterfall of dark, murky water."},{name:"Veiled Citadel",description:"Hidden by a permanent illusion that makes it look like a simple, ruined windmill."},{name:"Blightspire",description:"Plants wither and birds drop dead within a mile of this poisonous fortress."},{name:"Casket Keep",description:"The architecture is based entirely on funerary geometry and tomb design."},{name:"Ivory Shard Castle",description:"Built from polished white stone that reflects the moonlight with blinding intensity."},{name:"Grimreach Manor",description:"A sprawling estate where the hallways shift and change their length at random."},{name:"Evernight Fortress",description:"A dome of magical darkness permanently encapsulates this massive stronghold."},{name:"The Bone Lattice",description:"A bizarre castle where the walls are a woven mesh of gargantuan ribs."},{name:"Starless Hold",description:"A subterranean castle built in a cave so vast it has its own weather system."},{name:"Whisperwind Castle",description:"The walls are riddled with tiny holes that make the wind sound like hushed voices."},{name:"The Red Cathedral",description:"A gothic masterpiece dedicated to the divinity of blood."},{name:"Serpent's  Coil Keep",description:"A winding, spiral fortress that climbs up a jagged rock formation."},{name:"Iron Shroud Citadel",description:"Wrapped in massive iron chains that supposedly hold the building together."},{name:"Lamentation Hall",description:"The stones are enchanted to echo the last thoughts of those who die within."},{name:"Nocturnal Manor",description:"A place where clocks run backward and dinner is served at the stroke of midnight."},{name:"Vampyre's  Vigil",description:"A watchtower on the highest peak, overlooking the entire mortal realm."},{name:"Malice Guard",description:"A brutal, practical fortress designed for a war that has lasted centuries."},{name:"Spectral Spire",description:"The upper floors are transparent, revealing the ghosts that reside within."},{name:"Hemlock Hold",description:"Surrounded by a moat of liquid poison and gardens of deadly nightshade."},{name:"The Obsidian Maw",description:"The gatehouse looks like a screaming face; the portcullis is its teeth."},{name:"Fallen Star Castle",description:"Built around a meteorite that radiates an unsettling, alien energy."},{name:"Withered Rose Estate",description:"A crumbling manor where time seems to have stopped mid-ball 400 years ago."},{name:"The Leech Citadel",description:"The walls pulse with a faint light whenever someone is wounded nearby."},{name:"Shadowbrook Manor",description:"A peaceful-looking house that hides a sprawling complex of torture chambers."},{name:"Dreadnought Keep",description:"Built to look like a massive stone ship stranded on a mountain top."},{name:"Bloodline Hall",description:"Every room is decorated with the preserved hearts of the family ancestors."},{name:"The Glass Sepulcher",description:"A castle made of reinforced glass, showing the coffins stored in the walls."},{name:"Marrowstone Fortress",description:"The mortar used in the walls was mixed with the ground-up bones of slaves."},{name:"Nightmare Reach",description:"Sleepers within its walls suffer from shared, prophetic dreams of the end of the world."},{name:"Cryptic Spire",description:"Covered in runes that no living scholar can translate without going mad."},{name:"The Hanging Palace",description:"Suspended by massive chains over a bottomless chasm."},{name:"Brimstone Manor",description:"Smells eternally of sulfur and the fires of a deeper, darker place."},{name:"The Flayed Keep",description:"The exterior walls are draped in banners that look suspiciously like tanned leather."},{name:"Silent Grave Citadel",description:"A fortress where the guards are all decapitated undead who never make a sound."},{name:"Amberblood Hold",description:"The lord of this castle is preserved in a giant block of enchanted amber."},{name:"The Hollow Sovereign",description:"A castle that appears grand from the front, but is just a hollow shell in the back."},{name:"Thornheart Castle",description:"Massive, iron-hard briars grow through the masonry, acting as natural barbed wire."},{name:"The Gossamer Wing",description:"A delicate-looking castle built by vampires who miss the elegance of the fey wild."},{name:"Soul-Anchor Hold",description:"Legend says the castle stays upright only because of the souls trapped in the foundation."},{name:"The Carrion Nest",description:"Built atop a massive pile of discarded armor and weapons from a forgotten war."},{name:"Vespera's  Grace",description:"A beautiful, haunting manor that smells of expensive perfume and old earth."},{name:"The Iron Maiden",description:"The entire castle is a single, giant trap designed to kill anyone who enters uninvited."},{name:"Duskfell Manor",description:"The shadows here have a life of their own and sometimes detach from their owners."},{name:"The Cursed Crown",description:"A circular fortress with golden-tipped spires that look like a king's  crown."},{name:"Sorrow-Wrought Spire",description:"Built by a mason who cried throughout the entire construction."},{name:"The Black Chalice",description:"A tower shaped like a cup, used to collect rainwater for dark rituals."},{name:"Mist-Veil Bastion",description:"It disappears entirely during the day, reappearing only when the sun sets."},{name:"The Final Breath",description:"A castle built on the very spot where the last king of the old world died."},{name:"Onyx Rib Keep",description:"The arches of the great hall are the bones of a long-dead dragon."},{name:"The Weeping Widow",description:"The castle is shaped like a cloaked woman looking out toward the sea."},{name:"Bleakwater Manor",description:"A flooded estate where the vampires sleep in stone chests underwater."},{name:"The Gargoyle's  Perch",description:"Home to more stone statues than living inhabitants."},{name:"Terror's  Edge",description:"A castle built on a narrow bridge spanning a mile-deep canyon."},{name:"The Sanguine Library",description:"A fortress dedicated to storing every book ever written in human blood."},{name:"Grave-Iron Hold",description:"The metal used in this castle was forged from melted-down cemetery fences."},{name:"The Pale Sovereign",description:"A gleaming white castle that looks holy until you see the flayed skins on the walls."},{name:"Bramble-Gate Manor",description:"The only way in is through a tunnel of sentient, hungry thorns."},{name:"The Shifting Shadow",description:"The castle's  layout changes every time a cloud passes over the moon."},{name:"Blood-Stained Sanctuary",description:"A place of refuge for monsters fleeing the wrath of the sun."},{name:"The Eternal Sentinel",description:"A tower that looks like a giant knight standing guard over the valley."},{name:"Wraith-Wood Palace",description:"Built into the canopy of a forest that died but refused to fall over."},{name:"The Frozen Heart",description:"The center of the castle is a room that is -100 degrees, containing a single coffin."},{name:"Ash-Heirloom Estate",description:"A manor built on the ruins of a city that was burned to the ground."},{name:"The Velvet Noose",description:"A luxurious castle where guests are pampered before they are executed."},{name:"Moon-Phase Citadel",description:"The doors only open during a specific phase of the lunar cycle."},{name:"The Iron Knot",description:"A confusing maze of metal corridors that lead mostly to dead ends."},{name:"Hells-Gate Keep",description:"Built over a volcanic vent that glows with a terrifying orange light."},{name:"The Carrion King's  Court",description:"A ruin decorated with the skulls of every animal found in the region."},{name:"Shadow-Step Manor",description:"To enter a new room, you must step through a portal of pure darkness."},{name:"The Bone-Dry Bastion",description:"A castle in the desert where the moisture is sucked out of any living visitor."},{name:"Lurid Hall",description:"Decorated in garish, bright colors that somehow make the horror even worse."},{name:"The Serpent's  Tooth",description:"A single, curved tower that leans precariously over the village below."},{name:"Sanguine Grotto",description:"A castle built inside a sea cave, accessible only when the tide is low."},{name:"The Last Resort",description:"A fortress designed to withstand a siege that lasts a thousand years."}]},Ne=["(1/⚀)","(2/⚁)","(3/⚂)","(4/⚃)","(5/⚄)","(6/⚅)"],{STAGE_TURNS:ls,STAGE_BASE_RATIOS:st,STAGE_RATIO_VARIANCE:te,STAGE_RATIO_MIN:se,STAGE_RATIO_MAX:rt,STAGE_RATIO_FINAL_MAX:at,STAGE3_MIN:ot,GARRISON_VARIANCE_MIN:nt,GARRISON_VARIANCE_MAX:us,GARRISON_SCALING_FACTOR:hs,GARRISON_SCALING_EXP:ds,GARRISON_BASE_FACTOR:cs,GARRISON_TOTAL_MIN:ps,GARRISON_STAGE_MIN:ms,DESERTER_RATE_BASE:gs,DESERTER_RETURN_MIN:ys,DESERTER_RETURN_MAX:fs,REROLL_BASE_COST:Es,REROLL_GROWTH:As,REROLL_GLOBAL_LIMIT:Rs,ARMY_POWER_WEIGHTS:Ye,GARRISON_POWER_WEIGHTS:Re,BASE_POWER_BY_TIER:Ss,STAGE_POWER_MULTIPLIERS:_s,GARRISON_COMPOSITION:Ms,STAGE_MODIFIERS:Mt,BOSS_PROFILE:O,STAGE_BREAK_REMAIN_BASE:Cs,STAGE_BREAK_REMAIN_MIN:Is,STAGE_BREAK_REMAIN_MAX:xs,STAGE_BREAK_TACTICS_SCALE:Ts,STAGE_BREAK_ARMY_SCALE:vs,STAGE_BREAK_ARMY_MAX:it,ESTIMATE_RATIO_STEEPNESS:Ct,ESTIMATE_TACTICS_SCALE:ws,ESTIMATE_TIER_RATIO_BASE:Os,ESTIMATE_TIER_RATIO_STEP:bs,ESTIMATE_SMALL_ARMY_RATIO:Ls,ESTIMATE_SMALL_ARMY_MIN:Ns,ESTIMATE_SMALL_ARMY_MAX:Ds,SIEGE_SURVIVAL_MIN:lt,SIEGE_SURVIVAL_MAX:Bs,SIEGE_STAGE_LOSS_FLOOR:ks,SIEGE_STAGE_LOSS_TIER_BONUS:Us,SIEGE_STAGE_LOSS_MAX:ut,BASE_PLAYER_HIT:It,BASE_PLAYER_CRIT:xt,BASE_ENEMY_HIT:Tt,BASE_ENEMY_CRIT:vt,CRIT_MULTIPLIER:ue}=Ge;function m(s,e,t){return Math.max(e,Math.min(t,s))}function De(s,e){return s+Math.random()*(e-s)}function Gs(s,e){return Math.floor(Math.random()*(e-s+1))+s}function wt(s){return s[Math.floor(Math.random()*s.length)]}function H(s,e=Ye){return s.weak*e.weak+s.normal*e.normal+s.elite*e.elite}function Hs(s){return s.weak*Re.weak+s.normal*Re.normal+s.strong*Re.strong}function $s(s){return Ss[s]}function Ys(s){return C.BASE_REWARD_BY_TIER[s]}function Ps(s){return{...s,basePower:$s(s.tier),baseReward:Ys(s.tier),rewardVariance:s.rewardVariance??1}}function Ws(s,e){const t=H(e,Ye),r=Math.pow(t,ds)*hs/100,a=Math.max(ps,s.basePower*(1+cs+r)),o=Ms[s.tier],n=[],i=_s.map(l=>a/3*l);for(let l=0;l<3;l++){let u=i[l];u*=1+nt+Math.random()*(us-nt),u=Math.max(ms,u);const p={weak:Math.floor(u*o.weak),normal:Math.floor(u*o.normal),strong:Math.floor(u*o.strong)};n.push({stage:l+1,power:Hs(p),units:p})}return{stages:n}}function Ot(s){const e=Vs();return[Se(s,e,0),Se(s,e,1),Se(s,e,2)]}function Vs(){let s=st[0]+De(-te,te),e=st[1]+De(-te,te);s=m(s,se,rt),e=m(e,se,rt);let t=1-s-e;if(t<ot){const r=ot-t;s=m(s-r*.5,se,at),e=m(e-r*.5,se,at),t=1-s-e}return[s,e,t]}function Se(s,e,t){return{weak:_e(s.weak,e)[t],normal:_e(s.normal,e)[t],elite:_e(s.elite,e)[t]}}function _e(s,e){const t=e.map(n=>s*n),r=t.map(Math.floor);let a=s-r.reduce((n,i)=>n+i,0);const o=t.map((n,i)=>({idx:i,frac:n-r[i]}));o.sort((n,i)=>i.frac-n.frac);for(let n=0;n<a;n++)r[o[n%o.length].idx]+=1;return r}function Fs(s){const e=H(Ks(s.stageArmies),Ye),t=s.garrison.stages.reduce((i,l)=>i+l.power,0);let r=e/(t+1);r*=1+ws*s.playerStats.tactics,r=m(r,.1,3),r/=bt(s.castle.tier),e<100&&(r*=Ls+Math.random()*(Ds-Ns));const a=Lt(Be(ke(r)));let o=1;for(let i=1;i<=3;i++){const l=Mt[i],u=m(It+l.playerHitBonus,.05,.95),p=m(xt+l.playerCritBonus,.01,.9),c=m(Tt+l.enemyHitBonus,.05,.95),d=m(vt+l.enemyCritBonus,.01,.9),I=u*l.playerDamageMul*(1+p*(ue-1)),_=c*l.enemyDamageMul*(1+d*(ue-1)),R=I/_*(a/l.lossMultiplier),v=ke(R);o*=v}o=Be(m(o,0,1));const n=Q(s.castle,s.playerLevel,e);return{survivalChance:o,expectedBlood:n}}function Ks(s){return{weak:s[0].weak+s[1].weak+s[2].weak,normal:s[0].normal+s[1].normal+s[2].normal,elite:s[0].elite+s[1].elite+s[2].elite}}function bt(s){return Os+(s-1)*bs}function Be(s){const e=m(s,0,1);return lt+(Bs-lt)*e}function ke(s){return 1/(1+Math.exp(-Ct*(s-1)))}function Lt(s){const e=m(s,.01,.99);return 1+Math.log(e/(1-e))/Ct}function Xs(s,e,t){const r=bt(t),a=s/(e+1),o=a>=1?Math.sqrt(a):1,n=a*o/r,i=ke(n),l=Be(i);return Math.max(.05,Lt(l))}function zs(s,e){const t=m(e-1,-.8,1.5),r=Cs+s*Ts+m(t*vs,-it,it);return m(r,Is,xs)}function ht(s,e,t){const r=s*.08+Math.random()*s*.04,a=t?e.playerDamageMul:e.enemyDamageMul;return Math.floor(r*a)}function Q(s,e,t){const r=Math.max(0,e-C.REWARD_LEVEL_OFFSET),a=C.REWARD_LEVEL_BASE*Math.pow(C.REWARD_LEVEL_GROWTH,r),o=1+s.tier*C.REWARD_TIER_MULTIPLIER,n=1+Math.log1p(t/C.REWARD_ARMY_LOG_BASE)*C.REWARD_ARMY_LOG_SCALE,i=Math.min(C.REWARD_ARMY_MAX_BONUS,n),l=s.rewardVariance??1,u=a*o*i*l;return Math.max(C.REWARD_MIN,Math.round(u))}function qs(s){const e=Mt[s.stage],t=H(s.stageArmy);if(t<=0)return{success:!1,turns:0,hits:0,crits:0,losses:{weak:0,normal:0,elite:0},deserters:{weak:0,normal:0,elite:0},remaining:{...s.stageArmy}};const r=t;let a=r;const o=s.garrisonStage.power;let n=o,i=0,l=0,u=0;for(let b=0;b<ls;b++){u+=1;const B=m(It+e.playerHitBonus,.05,.95),N=m(xt+e.playerCritBonus,.01,.9);if(Math.random()<B){let w=ht(a,e,!0);Math.random()<N&&(w=Math.floor(w*ue),l+=1),i+=1,n=Math.max(0,n-w)}const U=m(Tt+e.enemyHitBonus,.05,.95),k=m(vt+e.enemyCritBonus,.01,.9);if(Math.random()<U){let w=ht(n,e,!1);Math.random()<k&&(w=Math.floor(w*ue)),a=Math.max(0,a-w)}if(n<=0||a<=0)break}const p=r-a;let c=m(p/(r+1),0,.95)*e.lossMultiplier;const d=ks[s.stage]??0,I=(s.castleTier-1)*Us,_=m(d+I,0,ut);c=Math.max(c,_),c=m(c,0,ut);const R={weak:Math.min(s.stageArmy.weak,Math.floor(s.stageArmy.weak*c*1.05)),normal:Math.min(s.stageArmy.normal,Math.floor(s.stageArmy.normal*c*.9)),elite:Math.min(s.stageArmy.elite,Math.floor(s.stageArmy.elite*c*.75))},v=m(gs+e.deserterBonus-s.playerStats.charisma*.0015,.05,.25),L={weak:Math.min(R.weak,Math.floor(R.weak*v)),normal:Math.min(R.normal,Math.floor(R.normal*v)),elite:Math.min(R.elite,Math.floor(R.elite*v))},x={weak:Math.max(0,s.stageArmy.weak-R.weak),normal:Math.max(0,s.stageArmy.normal-R.normal),elite:Math.max(0,s.stageArmy.elite-R.elite)},y=Xs(r,s.garrisonStage.power,s.castleTier),M=zs(s.playerStats.tactics,y);return{success:n<=o*M&&H(x)>0,turns:u,hits:i,crits:l,losses:R,deserters:L,remaining:x}}function Qs(){return De(ys,fs)}function Js(s,e){const t=s.tier,r=O.BASE_HP+t*O.TIER_HP+e.level*O.LEVEL_HP,a=O.DAMAGE_MIN_BASE+t*O.DAMAGE_MIN_TIER+Math.floor(e.level*O.DAMAGE_MIN_LEVEL),o=O.DAMAGE_MAX_BASE+t*O.DAMAGE_MAX_TIER+Math.floor(e.level*O.DAMAGE_MAX_LEVEL),n=O.SPEED_BASE+t*O.SPEED_TIER+Math.floor(e.level*O.SPEED_LEVEL),i=O.STRENGTH_BASE+t*O.STRENGTH_TIER+Math.floor(e.level*O.STRENGTH_LEVEL),l=O.FEROCITY_BASE+t*O.FEROCITY_TIER,u=wt(["aggressive","cunning","feral"]);return{name:s.bossName,maxHp:r,damageMin:a,damageMax:o,speed:n,strength:i,ferocity:l,pattern:u}}function Pe(s,e){return!e||e.turns<=0?s:{...s,speed:Math.max(1,Math.floor(s.speed*(1+e.speedMod))),damageMin:Math.max(1,Math.floor(s.damageMin*(1+e.damageMod))),damageMax:Math.max(s.damageMin+1,Math.floor(s.damageMax*(1+e.damageMod)))}}function js(s){const e=Pe(s.boss,s.bossDebuff),t=s.playerStats.speed*1.2+s.playerStats.tactics*1.1+s.playerStats.strength*.6+s.playerStats.intelligence*.4,r=e.speed*1.3+e.ferocity*12,a=(t-r)/220,o=s.playerStats.strength*.6,n=(s.playerStats.tactics+s.playerStats.intelligence)*.003,i=m(.42+a,.1,.95),l=m(.6+a,.1,.95),u=m(.75+a,.1,.95);return[{id:"head",label:"Head strike",hitChance:i,critChance:m(.16+n,.06,.45),damageMin:Math.floor(18+o*.5),damageMax:Math.floor(30+o)},{id:"body",label:"Body strike",hitChance:l,critChance:m(.12+n,.05,.4),damageMin:Math.floor(12+o*.4),damageMax:Math.floor(22+o*.8)},{id:"limb",label:"Limb strike",hitChance:u,critChance:m(.09+n,.05,.35),damageMin:Math.floor(8+o*.3),damageMax:Math.floor(16+o*.6),debuffOnHit:{speedMod:-.15,damageMod:-.1,turns:2},debuffChance:.45}]}function Zs(s){const e=Pe(s.boss,s.bossDebuff),t=.45+(s.playerStats.speed-e.speed)*.03+s.playerStats.tactics*.006,r=m(t,.1,.9);return[{id:"left",label:"Dodge left",successChance:m(r+.05,.1,.95),failDamageMultiplier:1.1},{id:"right",label:"Dodge right",successChance:m(r+.05,.1,.95),failDamageMultiplier:1.1},{id:"duck",label:"Duck down",successChance:m(r-.05,.1,.95),failDamageMultiplier:.65},{id:"jump",label:"Jump upward",successChance:m(r-.02,.1,.95),failDamageMultiplier:1.25,counterChance:.25,counterDamageMin:6,counterDamageMax:12}]}function Me(s){const t=m(s,.1,.95)*6,r=Math.floor(t),a=t-r,o=Gs(1,6);let n=o<=r;return!n&&o===r+1&&a>0&&(n=Math.random()<a),{roll:o,symbol:Ne[o-1],threshold:r,remainder:a,success:n}}function er(s,e){const t=Es+e;return Math.round(t*Math.pow(As,s))}function tr(){return Rs}function ne(s){if(s.threshold<=0)return`⚀(${Math.round(s.remainder*100)}%)`;const e=Ne[Math.min(5,s.threshold-1)];if(s.remainder<=0)return e;const t=Ne[Math.min(5,s.threshold)];return`${e}+${t}(${Math.round(s.remainder*100)}%)`}function sr(s){if(s&&!(s.turns<=1))return{...s,turns:s.turns-1}}function rr(){return tt.data[Math.floor(Math.random()*tt.data.length)]}function ar(s){const e=Math.floor((s-6)/2);return m(e,1,5)}function or(s,e=5){const t=ar(s),r=[],a=Math.floor(e/2);for(let o=0;o<e;o++){const n=o-a,i=Math.random()<.35?Math.random()<.5?-1:1:0,l=m(t+n+i,1,5),u=rr(),p=m(C.REWARD_VARIANCE_MIN+Math.random()*(C.REWARD_VARIANCE_MAX-C.REWARD_VARIANCE_MIN),C.REWARD_VARIANCE_MIN,C.REWARD_VARIANCE_MAX);r.push(Ps({id:crypto.randomUUID(),name:u.name,description:u.description,tier:l,bossName:wt(is),rewardVariance:p}))}return r.sort((o,n)=>o.tier-n.tier)}function nr(s,e=5){const t=H(s.army),r=or(s.player.level,e),a=Ot(s.army);return pr(r,s.player.level,t),r.map(o=>{const n=Ws(o,s.army),i=Fs({castle:o,garrison:n,stageArmies:a,playerStats:s.player.stats,playerLevel:s.player.level});return{castle:o,garrison:n,estimates:i}})}function ie(s){const{state:e}=s;if(e.player.level<g.LEVEL_UNLOCK_CASTLE)return{state:e,messages:[`> The Lupine Siege awakens at level ${g.LEVEL_UNLOCK_CASTLE}.`,"> You are not yet ready to challenge the werewolf fortresses.","> [ 0 ] - Back"],dayConsumed:!1,options:[]};if(H(e.army)<=0)return{state:e,messages:[{text:"> Your warhost is insufficient for such a slaughter.",group:"error"},{text:"> Amass a greater force of thralls before you dare to lay siege.",group:"error"},"> [ 0 ] - Back"],dayConsumed:!1,options:[]};const r=s.options??nr(e,5),a=[{text:"> ======================================",group:"error",style:"warning"},{text:"> ====== TARGETS OF THE BLOOD WAR ======",group:"error",style:"warning"},{text:"> ======================================",group:"error",style:"warning"}];return r.forEach((o,n)=>{const i=mr(o.garrison),l=Math.round(o.estimates.survivalChance*100);a.push({text:`> [ ${n+1} ] ${o.castle.name.toUpperCase()} — THREAT LEVEL: ${o.castle.tier}`,group:"error",style:"warning"}),o.estimates.survivalChance<Ge.SURVIVAL_WARNING_THRESHOLD&&a.push({text:"> YOUR BLOOD IS THIN! Attempting this siege is suicide. Gather your legions or prepare for final death.",group:"error"}),a.push({text:`> ${o.castle.description}`,group:"system",style:"creative"}),a.push({text:`> GARRISON (TOTAL: ${i.total}): YEARLINGS: ${i.weak}, WARRIORS: ${i.normal}, PRIMALS: ${i.strong}`,group:"system",style:"creative"}),a.push({text:`> GRIM FORECAST: ${l}% chance to endure the slaughter.`,group:"system",style:"creative"}),a.push({text:`> POTENTIAL HARVEST: ${o.estimates.expectedBlood} BLOOD`,group:"system",style:"creative"})}),a.push({text:"> [ 0 ] - Back",group:"error",style:"warning"}),a.push({text:"> ======================================",group:"error",style:"warning"}),{state:e,messages:a,dayConsumed:!1,options:r}}function ir(s,e){const t=Ot(s.army),r=H(s.army),a=Js(e.castle,s.player);return{castle:e,stageArmies:t,stageIndex:0,initialArmyPower:r,deserters:{weak:0,normal:0,elite:0},losses:{weak:0,normal:0,elite:0},boss:a,bossHp:a.maxHp,playerHp:Math.round(s.player.stats.maxHp),playerMaxHp:Math.round(s.player.stats.maxHp),bossDebuff:void 0,rerollsUsed:0,rerollsThisAction:0,rerollLimit:tr(),pendingRoll:void 0,wifeSacrificeUsed:!1}}function Ce(s,e){const t=f.CASTLE_ASSAULT_COST,r=Q(e.castle.castle,s.player.level,H(s.army)),a=Math.round(e.castle.estimates.survivalChance*100);return[{text:"> ======= INITIATE THE SLAUGHTER =======",group:"system",style:"warning"},{text:`> TARGETED DEN: ${e.castle.castle.name}`,group:"system",style:"creative"},{text:`> THREAT LEVEL: ${e.castle.castle.tier}`,group:"system",style:"creative"},{text:`> POTENTIAL HARVEST: ${r} BLOOD`,group:"system",style:"creative"},{text:`> GRIM FORECAST: ${a}% CHANCE OF SURVIVAL`,group:"system",style:"creative"},{text:`> WAR TOLL: ${t} BLOOD`,group:"system",style:"creative"},{text:"> [ 1 ] - Unleash the Night (Begin the siege)",group:"game"},{text:"> [ 2 ] - Recall the Hordes (Choose another castle)",group:"error"}]}function lr(s,e){const t=[{text:`> ===== STAGE ${s}: ${gr(s)} =====`,group:"system",style:"warning"},{text:`> TURNS: ${e.turns} | HITS: ${e.hits} | CRITS: ${e.crits}`,group:"system",style:"creative"}],r=Ue(e.losses,"LOSS");r.length&&t.push(...r);const a=Ue(e.deserters,"DESERT");return a.length&&(t.push(...a),t.push("> Deserters may return if you survive the siege.")),t.push(e.success?"> The garrison breaks.":"> The siege stalls under heavy resistance."),t}function dt(){return[{text:"> [ 1 ] - Press onward",group:"system",style:"creative"},{text:"> [ 2 ] - Retreat (no BLOOD, losses are permanent)",group:"system",style:"creative"}]}function ur(s){return[{text:"> ===== STAGE 4: THE ALPHA =====",group:"error"},{text:`> A deafening howl shatters the air. ${s.boss.name.toUpperCase()} leaps from the ramparts!`,group:"system",style:"creative"},{text:`> Boss HP: ${s.bossHp}/${s.boss.maxHp}`,group:"system",style:"creative"},{text:`> Pattern: ${s.boss.pattern.toUpperCase()}`,group:"system",style:"creative"}]}function Ie(s,e,t){const r=[{text:"> ===== THE CLASH PERSISTS =====",group:"error",style:"warning"},{text:`> You: ${e.playerHp}/${e.playerMaxHp} HP | BLOOD ${s.player.blood}`,group:"game"},{text:`> Alpha: ${Math.max(0,e.bossHp)}/${e.boss.maxHp} HP | REROLLS: ${e.rerollsUsed}/${e.rerollLimit}`,group:"error"}];return t.forEach((a,o)=>{const n=Math.round(a.hitChance*100),i=Math.round(a.critChance*100);let l=`> [ ${o+1} ] - ${a.label} | HIT: ${n}% | DMG: ${a.damageMin}-${a.damageMax} | CRIT: ${i}%`;a.id==="limb"&&(l+=" | DEBUFF: SLOW"),r.push(l)}),r}function ct(s,e){const t=[{text:"> The alpha blurs forward. Time slows.",group:"system",style:"creative"},{text:"> Choose your evasion:",group:"system",style:"creative"}];return s.forEach((r,a)=>{const o=Math.round(r.successChance*100),n=Math.max(1,Math.floor(e*r.failDamageMultiplier*.8)),i=Math.max(n+1,Math.floor(e*r.failDamageMultiplier));let l="";r.id==="jump"&&(l=" | ON SUCCESS: counter chance"),t.push(`> [ ${a+1} ] - ${r.label} (${o}% SUCCESS) | FAIL: ${n}-${i} DMG${l}`)}),t}function re(s,e,t){const r=ne(e.roll);return[{text:"> REROLL AVAILABLE!.",group:"game"},{text:`> ROLL: ${e.roll.symbol} vs THRESHOLD: ${r}`,group:"system",style:"creative"},{text:`> COST: ${t} BLOOD | REMAINING REROLLS: ${s.rerollLimit-s.rerollsUsed}`,group:"system",style:"creative"},{text:"> [ 1 ] - Reroll",group:"system",style:"creative"},{text:"> [ 2 ] - Accept fate",group:"system",style:"creative"}]}function hr(s,e){const t=[{text:"> ======================================",group:"game"},{text:"> =============== VICTORY! =============",group:"game"},{text:"> ======================================",group:"game"},{text:"> The howls have finally fallen silent.",group:"game"},{text:"> The Alpha's head lies at your feet, and the stench of wet fur is replaced by the sweet aroma of victory.",group:"game"},{text:"> The stronghold is yours. The night belongs to the Kindred.",group:"game"},{text:"> ======================================",group:"game"},{text:`> +${s} BLOOD SEIZED FROM THE KEEP! ^(*,_,*)^`,group:"game"},{text:"> ======================================",group:"game"}],r=Ue(e,"RETURN");return r.length&&t.push(...r),t.push("> The night belongs to you."),t}function pt(){return[{text:"> ===== ASCENSION =====",group:"error"},{text:"> The alpha's fangs close. Darkness floods your sight.",group:"error"}]}function he(s,e){return{weak:s.weak+e.weak,normal:s.normal+e.normal,elite:s.elite+e.elite}}function dr(s){const e=Qs();return{weak:Math.floor(s.weak*e),normal:Math.floor(s.normal*e),elite:Math.floor(s.elite*e)}}function xe(s,e){return js({playerStats:s.player.stats,boss:e.boss,bossDebuff:e.bossDebuff})}function mt(s,e){return Zs({playerStats:s.player.stats,boss:e.boss,bossDebuff:e.bossDebuff})}function Te(s,e,t,r,a){return{kind:s,profile:e,roll:t,incomingDamage:r,incomingCrit:a}}function P(s){return er(s.rerollsUsed,s.castle.castle.tier)}function ae(s,e){if(s.rerollsUsed>=s.rerollLimit||s.rerollsThisAction>=2)return!1;const t=P(s);return e.player.blood>=t}function cr(s,e){const t=P(e);return s.player.blood=Math.max(0,s.player.blood-t),e.rerollsUsed+=1,e.rerollsThisAction+=1,t}function pr(s,e,t){const r=new Set;s.forEach((a,o)=>{a.rewardVariance=m(a.rewardVariance+o*C.REWARD_UNIQUE_NUDGE,C.REWARD_VARIANCE_MIN,C.REWARD_VARIANCE_MAX);let n=Q(a,e,t),i=0;for(;r.has(n)&&i<C.REWARD_UNIQUE_ATTEMPTS;)a.rewardVariance=m(a.rewardVariance+C.REWARD_UNIQUE_STEP,C.REWARD_VARIANCE_MIN,C.REWARD_VARIANCE_MAX),n=Q(a,e,t),i+=1;r.add(n)})}function mr(s){const e=s.stages.reduce((t,r)=>(t.weak+=r.units.weak,t.normal+=r.units.normal,t.strong+=r.units.strong,t),{weak:0,normal:0,strong:0});return{...e,total:e.weak+e.normal+e.strong}}function Ue(s,e){const t=[],r=e==="RETURN"?"+":"-",a=e==="LOSS"?"LOSS":e==="DESERT"?"DESERTERS":"RETURN";return s.weak>0&&t.push(`${a}: ${r}${s.weak} SHOVELHEADS`),s.normal>0&&t.push(`${a}: ${r}${s.normal} GHOULS`),s.elite>0&&t.push(`${a}: ${r}${s.elite} REVENANTS`),t.length?t.map(o=>`> ${o}`):[]}function gr(s){switch(s){case 1:return"CASTLE WALLS";case 2:return"GATES & RAMPARTS";case 3:return"INNER COURTYARDS";default:return"UNKNOWN"}}function yr(s){const e=f.CASTLE_ASSAULT_COST;return{ok:s.player.blood>=e,cost:e}}function fr(s){const e=f.CASTLE_ASSAULT_COST;return s.player.blood=Math.max(0,s.player.blood-e),e}function Er(s,e,t){s.losses=he(s.losses,e),s.deserters=he(s.deserters,t)}class Ar{menuContext={state:"select",selectedIndex:-1};castleOptions=[];siegeSession=null;pendingEvasion=null;handleCommand(e,t){if(e==="castle_start"){this.menuContext.state="select";const r=ie({state:t});return this.castleOptions=r.options,{state:t,messages:r.messages,dayConsumed:!1,nextState:"ACTION_MENU"}}switch(this.menuContext.state){case"select":return this.handleSelection(e,t);case"confirm":return this.handleConfirm(e,t);case"retreat":return this.handleRetreat(e,t);case"boss_action":return this.handleBossAction(e,t);case"boss_evasion":return this.handleBossEvasion(e,t);case"boss_reroll":return this.handleBossReroll(e,t);default:return{state:t,messages:["> ERROR: Unknown siege state"],dayConsumed:!1,nextState:"LOBBY"}}}handleSelection(e,t){if(e==="0"||e==="ex"||e==="exit")return this.reset(),{state:t,messages:["> Returning to day actions..."],dayConsumed:!1,nextState:"LOBBY"};const r=Number(e);if(!Number.isInteger(r)||r<1||r>this.castleOptions.length){const a=ie({state:t,options:this.castleOptions});return{state:t,messages:[{text:`> Invalid choice: "${e}"`,group:"error"},...a.messages],dayConsumed:!1,nextState:"ACTION_MENU"}}return this.menuContext.selectedIndex=r-1,this.menuContext.state="confirm",this.siegeSession=ir(t,this.castleOptions[this.menuContext.selectedIndex]),{state:t,messages:Ce(t,this.siegeSession),dayConsumed:!1,nextState:"ACTION_MENU"}}handleConfirm(e,t){if(!this.siegeSession)return{state:t,messages:["> ERROR: Siege session missing"],dayConsumed:!1,nextState:"LOBBY"};if(e==="2"||e==="0"){this.menuContext.state="select";const a=ie({state:t,options:this.castleOptions});return{state:t,messages:a.messages,dayConsumed:!1,nextState:"ACTION_MENU"}}if(e!=="1")return{state:t,messages:[{text:`> Invalid choice: "${e}"`,group:"error"},...Ce(t,this.siegeSession)],dayConsumed:!1,nextState:"ACTION_MENU"};const r=yr(t);return r.ok?(fr(t),this.resolveStage(t)):{state:t,messages:[{text:"> Your veins run too thin for this siege.",group:"error"},{text:`> Required: ${r.cost} BLOOD`,group:"error"},{text:`> Current: ${t.player.blood} BLOOD`,group:"system"},...Ce(t,this.siegeSession)],dayConsumed:!1,nextState:"ACTION_MENU"}}handleRetreat(e,t){if(!this.siegeSession)return{state:t,messages:["> ERROR: Siege session missing"],dayConsumed:!1,nextState:"LOBBY"};if(e==="2"){const r=this.finalizeSiege(t,!1);return this.reset(),{...r,messages:["> You order a retreat. No BLOOD is claimed.",...r.messages]}}return e!=="1"?{state:t,messages:[{text:`> Invalid choice: "${e}"`,group:"error"},...dt()],dayConsumed:!1,nextState:"ACTION_MENU"}:this.resolveStage(t)}handleBossAction(e,t){if(!this.siegeSession)return{state:t,messages:["> ERROR: Siege session missing"],dayConsumed:!1,nextState:"LOBBY"};const r=xe(t,this.siegeSession),a=Number(e);if(!Number.isInteger(a)||a<1||a>r.length)return{state:t,messages:[{text:`> Invalid choice: "${e}"`,group:"error"},...Ie(t,this.siegeSession,r)],dayConsumed:!1,nextState:"ACTION_MENU"};const o=r[a-1];this.siegeSession.pendingRoll=void 0,this.siegeSession.rerollsThisAction=0;const n=Me(o.hitChance),i=[`> You choose ${o.label}.`,`> Roll: ${n.symbol} vs Threshold ${ne(n)}`];return!n.success&&ae(this.siegeSession,t)?(this.siegeSession.pendingRoll=Te("attack",o,n),this.menuContext.state="boss_reroll",{state:t,messages:[...i,...re(this.siegeSession,this.siegeSession.pendingRoll,P(this.siegeSession))],dayConsumed:!1,nextState:"ACTION_MENU"}):this.resolveAttackRoll(t,o,n,i)}handleBossEvasion(e,t){if(!this.siegeSession||!this.pendingEvasion)return{state:t,messages:["> ERROR: Evasion context lost"],dayConsumed:!1,nextState:"LOBBY"};const r=mt(t,this.siegeSession),a=Number(e);if(!Number.isInteger(a)||a<1||a>r.length)return{state:t,messages:[{text:`> Invalid choice: "${e}"`,group:"error"},...ct(r,this.pendingEvasion.damage)],dayConsumed:!1,nextState:"ACTION_MENU"};const o=r[a-1];this.siegeSession.pendingRoll=void 0,this.siegeSession.rerollsThisAction=0;const n=Me(o.successChance),i=[`> You attempt: ${o.label}.`,`> Roll: ${n.symbol} vs Threshold ${ne(n)}`];return!n.success&&ae(this.siegeSession,t)?(this.siegeSession.pendingRoll=Te("evasion",o,n,this.pendingEvasion.damage,this.pendingEvasion.crit),this.menuContext.state="boss_reroll",{state:t,messages:[...i,...re(this.siegeSession,this.siegeSession.pendingRoll,P(this.siegeSession))],dayConsumed:!1,nextState:"ACTION_MENU"}):this.resolveEvasionRoll(t,o,n,this.pendingEvasion.damage,this.pendingEvasion.crit,i)}handleBossReroll(e,t){if(!this.siegeSession||!this.siegeSession.pendingRoll)return{state:t,messages:["> ERROR: Nothing to reroll"],dayConsumed:!1,nextState:"LOBBY"};const r=this.siegeSession.pendingRoll;if(e!=="1"&&e!=="2")return{state:t,messages:[{text:`> Invalid choice: "${e}"`,group:"error"},...re(this.siegeSession,r,P(this.siegeSession))],dayConsumed:!1,nextState:"ACTION_MENU"};if(e==="2"||!ae(this.siegeSession,t))return this.siegeSession.pendingRoll=void 0,r.kind==="attack"?this.resolveAttackRoll(t,r.profile,r.roll,["> You accept the miss."]):this.resolveEvasionRoll(t,r.profile,r.roll,r.incomingDamage??0,r.incomingCrit??!1,["> You accept the blow."]);cr(t,this.siegeSession);const a=Me(r.kind==="attack"?r.profile.hitChance:r.profile.successChance);this.siegeSession.pendingRoll=Te(r.kind,r.profile,a,r.incomingDamage,r.incomingCrit);const o=[`> Reroll: ${a.symbol} vs Threshold ${ne(a)}`];return!a.success&&ae(this.siegeSession,t)?(this.menuContext.state="boss_reroll",{state:t,messages:[...o,...re(this.siegeSession,this.siegeSession.pendingRoll,P(this.siegeSession))],dayConsumed:!1,nextState:"ACTION_MENU"}):(this.siegeSession.pendingRoll=void 0,r.kind==="attack"?this.resolveAttackRoll(t,r.profile,a,o):this.resolveEvasionRoll(t,r.profile,a,r.incomingDamage??0,r.incomingCrit??!1,o))}resolveStage(e){if(!this.siegeSession)return{state:e,messages:["> ERROR: Siege session missing"],dayConsumed:!1,nextState:"LOBBY"};const t=this.siegeSession.stageIndex,r=t+1,a=this.siegeSession.stageArmies[t],o=this.siegeSession.castle.garrison.stages[t],n=qs({stage:r,stageArmy:a,garrisonStage:o,playerStats:e.player.stats,castleTier:this.siegeSession.castle.castle.tier});this.siegeSession.stageArmies[t]=n.remaining,Er(this.siegeSession,n.losses,n.deserters);const i=[...lr(r,n)];if(!n.success){const u=this.finalizeSiege(e,!1);return this.reset(),{...u,messages:[...i,"> The assault collapses. You retreat into the night.",...u.messages]}}if(t<2)return this.siegeSession.stageIndex=t+1,this.menuContext.state="retreat",{state:e,messages:[...i,"> Retreat is still possible.",...dt()],dayConsumed:!1,nextState:"ACTION_MENU"};this.menuContext.state="boss_action";const l=xe(e,this.siegeSession);return{state:e,messages:[...i,...ur(this.siegeSession),...Ie(e,this.siegeSession,l)],dayConsumed:!1,nextState:"ACTION_MENU"}}resolveAttackRoll(e,t,r,a){if(!this.siegeSession)return{state:e,messages:["> ERROR: Siege session missing"],dayConsumed:!1,nextState:"LOBBY"};if(!r.success)return a.push("> Your strike misses."),this.resolveBossCounter(e,a);const o=Math.random()<t.critChance,n=Math.max(1,Math.floor(ve(t.damageMin,t.damageMax)*(o?1.8:1)));return this.siegeSession.bossHp=Math.max(0,this.siegeSession.bossHp-n),o?a.push(`> CRITICAL! The alpha reels (-${n} HP).`):a.push(`> You draw blood (-${n} HP).`),t.id==="limb"&&t.debuffOnHit&&Math.random()<(t.debuffChance??0)&&(this.siegeSession.bossDebuff={...t.debuffOnHit},a.push("> The alpha falters. Its speed wanes.")),this.siegeSession.bossHp<=0?this.finalizeSiege(e,!0,a):this.resolveBossCounter(e,a)}resolveEvasionRoll(e,t,r,a,o,n){if(!this.siegeSession)return{state:e,messages:["> ERROR: Siege session missing"],dayConsumed:!1,nextState:"LOBBY"};if(r.success){if(n.push("> You evade the strike."),t.counterChance&&Math.random()<t.counterChance){const u=Math.floor(ve(t.counterDamageMin,t.counterDamageMax));if(this.siegeSession.bossHp=Math.max(0,this.siegeSession.bossHp-u),n.push(`> You counter (-${u} HP).`),this.siegeSession.bossHp<=0)return this.finalizeSiege(e,!0,n)}return this.resumeBossRound(e,n)}const i=Math.max(1,Math.floor(a*t.failDamageMultiplier));return this.applyBossDamage(e,i,o,n)?{state:e,messages:[...n,...pt()],dayConsumed:!0,gameOver:!1,nextState:"LOBBY"}:this.resumeBossRound(e,n)}resolveBossCounter(e,t){if(!this.siegeSession)return{state:e,messages:t,dayConsumed:!1,nextState:"LOBBY"};const r=Pe(this.siegeSession.boss,this.siegeSession.bossDebuff),a=this.getPatternBonus(r.pattern),o=r.speed-e.player.stats.speed,n=m(.18+o*.02+a.evasion,.1,.4);if(Math.random()<n){const u=this.rollBossDamage(r),p=Math.random()<m(.12+r.ferocity*.6+a.crit,.08,.35);this.pendingEvasion={damage:u,crit:p},this.menuContext.state="boss_evasion";const c=mt(e,this.siegeSession);return{state:e,messages:[...t,...ct(c,u)],dayConsumed:!1,nextState:"ACTION_MENU"}}const i=m(.6+r.speed*.02-e.player.stats.speed*.015+a.hit,.25,.9),l=m(.12+r.ferocity*.6+a.crit,.08,.35);if(Math.random()<i){const u=Math.random()<l,p=this.rollBossDamage(r)*(u?1.6:1);if(this.applyBossDamage(e,Math.floor(p),u,t))return{state:e,messages:[...t,...pt()],dayConsumed:!0,gameOver:!1,nextState:"LOBBY"}}else t.push("> The alpha's strike misses.");return this.resumeBossRound(e,t)}resumeBossRound(e,t){if(!this.siegeSession)return{state:e,messages:t,dayConsumed:!1,nextState:"LOBBY"};this.pendingEvasion=null,this.siegeSession.bossDebuff=sr(this.siegeSession.bossDebuff);const r=xe(e,this.siegeSession);return this.menuContext.state="boss_action",{state:e,messages:[...t,"> ",...Ie(e,this.siegeSession,r)],dayConsumed:!1,nextState:"ACTION_MENU"}}applyBossDamage(e,t,r,a){if(!this.siegeSession)return!0;if(r&&t>=this.siegeSession.playerHp&&!this.siegeSession.wifeSacrificeUsed&&e.companions.wives.length>0&&Math.random()<.2){const o=Math.floor(Math.random()*e.companions.wives.length),n=e.companions.wives.splice(o,1)[0];return this.siegeSession.wifeSacrificeUsed=!0,a.push("> The strike would end you..."),a.push(`> ${n.name} throws herself into the maul. She is gone.`),a.push("> You live."),!1}return this.siegeSession.playerHp=Math.max(0,this.siegeSession.playerHp-t),e.player.combatState.currentHp=this.siegeSession.playerHp,r?a.push(`> CRITICAL! The alpha rends you (-${t} HP).`):a.push(`> The alpha strikes (-${t} HP).`),this.siegeSession.playerHp<=0?(e.player.combatState.currentHp=0,!0):!1}finalizeSiege(e,t,r=[]){if(!this.siegeSession)return{state:e,messages:r,dayConsumed:!0,nextState:"LOBBY"};const a=this.siegeSession.stageArmies.reduce((o,n)=>he(o,n),{weak:0,normal:0,elite:0});if(t){const o=dr(this.siegeSession.deserters);e.army=he(a,o);const n=Q(this.siegeSession.castle.castle,e.player.level,this.siegeSession.initialArmyPower);return e.player.blood+=n,e.statistics.conqueredCastles+=1,{state:e,messages:[...r,...hr(n,o)],dayConsumed:!0,gameOver:!1,nextState:"LOBBY"}}return e.army=a,{state:e,messages:r,dayConsumed:!0,gameOver:!1,nextState:"LOBBY"}}getPatternBonus(e){switch(e){case"aggressive":return{hit:.05,crit:.04,evasion:-.04};case"cunning":return{hit:-.02,crit:.06,evasion:.08};case"feral":return{hit:.03,crit:.02,evasion:0};default:return{hit:0,crit:0,evasion:0}}}rollBossDamage(e){const t=ve(e.damageMin,e.damageMax);return Math.floor(t+e.strength*.4)}reset(){this.menuContext={state:"select",selectedIndex:-1},this.castleOptions=[],this.siegeSession=null,this.pendingEvasion=null}}function ve(s,e){return s+Math.random()*(e-s)}class Rr{menu=null;mode="MENU";pendingAction=null;start(e){return this.menu=this.createRootMenu(),this.mode="MENU",this.pendingAction=null,{state:e,messages:this.menu.render()}}handleCommand(e,t){if(this.mode==="INPUT_NUMBER"&&this.pendingAction){const a=Number(e);return Number.isFinite(a)?(this.applyCheat(t,this.pendingAction,a),this.mode="MENU",this.pendingAction=null,this.menu=this.createRootMenu(),{state:t,messages:[{text:"> Cheat applied successfully.",group:"system"},...this.menu.render()]}):{state:t,messages:[{text:"> Please enter a valid number.",group:"error"},{text:"> How many do you want to add?",group:"system"}]}}if(!this.menu)return{state:t,messages:["> ERROR: Cheat menu not initialized"]};const r=this.menu.processInput(e);return r?r.optionId==="attributes"?(this.menu=this.createAttributesMenu(),{state:t,messages:this.menu.render()}):r.optionId==="back"?(this.menu=this.createRootMenu(),{state:t,messages:this.menu.render()}):(this.mode="INPUT_NUMBER",this.pendingAction=r.optionId,{state:t,messages:[{text:"> How many do you want to add?",group:"system"}]}):e==="0"?{state:t,messages:["> Cheat menu closed."],exit:!0}:{state:t,messages:[{text:"> INVALID SELECTION",group:"error"},...this.menu.render()]}}applyCheat(e,t,r){switch(t){case"level":e.player.level+=r;break;case"blood":e.player.blood+=r;break;case"days":e.world.currentDay+=r;break;default:e.player.stats[t]+=r}}createRootMenu(){return new V({title:"CHEAT MENU",titleStyle:{group:"game",style:"creative"},options:[{id:"level",label:"Add LEVELS"},{id:"blood",label:"Add BLOOD"},{id:"days",label:"Add DAYS"},{id:"attributes",label:"Add ATTRIBUTES"}],optionStyle:{group:"system",style:"creative"},footerText:{lines:["[ 0 ] - Back"],style:{group:"game",style:"title"}}})}createAttributesMenu(){return new V({title:"ATTRIBUTES",titleStyle:{group:"game",style:"creative"},options:[{id:"maxHp",label:"Add HP"},{id:"strength",label:"Add STRENGTH"},{id:"speed",label:"Add SPEED"},{id:"charisma",label:"Add CHARISMA"},{id:"intelligence",label:"Add INTELLIGENCE"},{id:"tactics",label:"Add TACTICS"},{id:"seduction",label:"Add SEDUCTION"}],optionStyle:{group:"system",style:"creative"},footerText:{lines:["[ 0 ] - Back"],style:{group:"game",style:"title"}}})}}function Sr(s){const e={weak:0,normal:0,elite:0};if(!s.companions.wives.length)return{generated:e,hasGeneration:!1};for(const t of s.companions.wives)e.weak+=t.armyGeneration.weak,e.normal+=t.armyGeneration.normal,e.elite+=t.armyGeneration.elite;return s.army.weak+=e.weak,s.army.normal+=e.normal,s.army.elite+=e.elite,{generated:e,hasGeneration:e.weak+e.normal+e.elite>0}}function q(s,e,t="BODYGUARDS_MENU"){const r=s.companions.bodyguards;if(!r||r.length===0)return{messages:[{text:"> ========== WITHOUT A SHADOW ==========",group:"system",style:"creative"},{text:"> Your shadows are empty. No blade is sworn to your defense...",group:"system"}],nextState:"ACTION_MENU"};const a=r[0];if(t==="BODYGUARDS_MENU")return e?e==="0"||e?.toLowerCase()==="back"?{messages:[{text:"> Returning to day actions...",group:"system",style:"separator"},...A.back],nextState:"ACTION_MENU"}:e==="1"?{messages:[{text:"> ======================================",group:"system",style:"separator"},{text:"> Are you sure you want to fire your bodyguard?",group:"system"},{text:"> This action cannot be undone.",group:"error"},{text:"> [ 1 ] - Yes, dismiss them",group:"system"},{text:"> [ 2 ] - No, keep them",group:"system"},{text:"> ======================================",group:"system",style:"separator"}],nextState:"BODYGUARD_DISMISS_CONFIRM"}:{messages:[{text:`Invalid command: "${e}"`,group:"error"},...q(s).messages]}:{messages:[{text:"> ======================================",group:"system",style:"separator"},{text:`> Your Bodyguard: ${a.name}`,group:"system"},{text:a.description,group:"system",style:"separator"},{text:`> CHARISMA: ${a.attributes.charisma} | TACTICS: ${a.attributes.tactics} | STRENGTH: ${a.attributes.strength}`,group:"system"},{text:a.used?"Status: Dead":"Status: Ready",group:"system"},{text:"> --------------------------------------",group:"system",style:"separator"},{text:"> [ 1 ] - Fire bodyguard",group:"system"},{text:"> [ 0 ] - Back",group:"system"}]};if(t==="BODYGUARD_DISMISS_CONFIRM"){if(e==="1")return s.companions.bodyguards=[],s.statistics.changedBodyguards++,{messages:[{text:"> Your bodyguard has left your service.",group:"system"},{text:"> Returning to day actions...",group:"system",style:"separator"},...A.back],nextState:"ACTION_MENU"};if(e==="2"||e==="0"){const o=q(s,void 0,"BODYGUARDS_MENU");return{messages:[{text:"> Keeping your bodyguard.",group:"system"},...o.messages],nextState:"BODYGUARDS_MENU"}}return{messages:[{text:`Invalid choice: "${e}"`,group:"error"},...q(s,void 0,"BODYGUARD_DISMISS_CONFIRM").messages],nextState:"BODYGUARD_DISMISS_CONFIRM"}}return{messages:[{text:"Error: Invalid bodyguard state",group:"error"}],nextState:"ACTION_MENU"}}function we(s){const{state:e}=s,t=[];return t.push({text:"> ========= THE DARKENED COURT =========",group:"game",style:"creative"}),e.companions.wives.length?(e.companions.wives.forEach((r,a)=>{t.push({text:`> [ ${a+1} ] - ${r.name} (age:${r.age}, ${r.profession??"unknown"})`,group:"game"})}),t.push({text:"> [ 0 ] - Back",group:"system",style:"title"}),t.push({text:"> ======================================",group:"game",style:"creative"}),{state:e,messages:t,dayConsumed:!1}):(t.push({text:"> Your chambers are silent. You have no consorts bound to your will.",group:"system"}),e.player.level<g.LEVEL_UNLOCK_WIFE&&t.push({text:`> Your Blood is too weak. Consorts can only be bound at level ${g.LEVEL_UNLOCK_WIFE}.`,group:"error"}),{state:e,messages:t,dayConsumed:!1,nextState:"LOBBY"})}function Oe(s){const{state:e,wifeIndex:t}=s,r=e.companions.wives[t];if(!r)return{state:e,messages:["> Error: Wife not found"],dayConsumed:!1};const a=[{text:`> ===== ${r.name.toUpperCase()} =====`,group:"game"},{text:"> [ 1 ] - Behold her qualities",group:"game",style:"creative"},{text:"> [ 2 ] - Sever the Bond",group:"game",style:"creative"},{text:"> [ 0 ] - Back",group:"game",style:"title"},{text:"> =============",group:"game",style:"creative"}];return{state:e,messages:a,dayConsumed:!1}}function _r(s){const{state:e,wifeIndex:t}=s,r=e.companions.wives[t];if(!r)return{state:e,messages:["> Error: Wife not found"],dayConsumed:!1};const a=r.bonus.seduction??0,o=Math.floor(a*.5),n=Math.floor(a*.3),i=Math.floor(a*.2),l=[{text:`> ===== ${r.name.toUpperCase()} =====`,group:"game"},{text:`> YEARS: ${r.age} / ${r.profession}`,group:"system",style:"creative"},{text:`> DAYS TOGETHER: ${r.daysTogether}`,group:"system",style:"creative"},{text:"> ============= ATTRIBUTES =============",group:"game"},{text:`> SEDUCTION: [ ${a} ] ' CHARISMA: [ ${r.bonus.charisma??0} ]`,group:"game"},{text:`> INTELLIGENCE: [ ${r.bonus.intelligence??0} ] ' TACTICS: [ ${r.bonus.tactics??0} ]`,group:"game"},{text:"> ======= ARMY GENERATION BONUS ========",group:"system"},{text:`> SHOVELHEADS: +${o}`,group:"system"},{text:`> GHOULS: +${n}`,group:"system"},{text:`> REVENANTS: +${i}`,group:"system"},{text:"> [ 0 ] - Back",group:"system",style:"title"},{text:"> ======================================",group:"game",style:"creative"}];return{state:e,messages:l,dayConsumed:!1}}function Mr(s){const{state:e,wifeIndex:t}=s;return e.companions.wives[t]?{state:e,messages:[{text:"> Are you certain you wish to sever the bond with this consort?",group:"error",style:"creative"},{text:"> She will be lost to the night. \\(o,_,o)/",group:"error"},{text:"> [ 1 ] - Yes",group:"error"},{text:"> [ 2 ] - No",group:"game"}],dayConsumed:!1}:{state:e,messages:["> Error: Wife not found"],dayConsumed:!1}}class gt{gameState;finished=!1;currentState="LOBBY";menuContext=null;villageActionManager=null;castleAssaultManager=null;cheatMenuManager=null;wivesContext=null;pendingArmyDissolve=null;constructor(e){this.gameState=e||this.createInitialSave()}checkForDefeat(e=[]){const t=this.gameState.player.combatState.currentHp<=0,r=this.gameState.player.blood<=0;if(!t&&!r)return e;if(ft(this.gameState)){const a=[...e,...A.bodyguardSavePlayer];return t&&(this.gameState.player.combatState.currentHp=Math.floor(this.gameState.player.stats.maxHp*.3),a.push({text:"> You survive with grievous wounds...",group:"system",style:"creative"})),r&&(this.gameState.player.blood=1,a.push({text:"> Your veins are nearly dry, but you cling to unlife...",group:"system",style:"creative"})),a}return this.finished=!0,this.currentState="GAME_OVER",[...e,...A.gameOver]}handleWivesListInput(e){if(e==="0")return this.currentState="ACTION_MENU",this.menuContext&&this.menuContext.menuEngine?this.menuContext.menuEngine.render():this.nextDay();const t=Number(e)-1;return isNaN(t)||!this.gameState.companions.wives[t]?[{text:"> Invalid selection",group:"error"}]:(this.currentState="WIFE_SUBMENU",this.wivesContext={selectedIndex:t},Oe({state:this.gameState,wifeIndex:t}).messages)}handleWifeSubmenuInput(e){const t=this.wivesContext.selectedIndex;return e==="0"?(this.currentState="WIVES_MENU",we({state:this.gameState}).messages):e==="1"?(this.currentState="WIFE_DETAILS",_r({state:this.gameState,wifeIndex:t}).messages):e==="2"?(this.currentState="WIFE_CONFIRM",Mr({state:this.gameState,wifeIndex:t}).messages):[{text:"> Invalid option",group:"error"}]}handleWifeDetailsInput(e){return e==="0"?(this.currentState="WIFE_SUBMENU",Oe({state:this.gameState,wifeIndex:this.wivesContext.selectedIndex}).messages):[{text:"> Invalid option",group:"error"}]}handleWifeConfirmInput(e){const t=this.wivesContext.selectedIndex;return e==="1"?(this.gameState.companions.wives.splice(t,1),this.gameState.statistics.changedWives++,this.currentState="WIVES_MENU",this.wivesContext={selectedIndex:null},we({state:this.gameState}).messages):e==="2"||e==="0"?(this.currentState="WIFE_SUBMENU",Oe({state:this.gameState,wifeIndex:t}).messages):[{text:"> Invalid option",group:"error"}]}getArmyDissolveValues(){const e=this.gameState.army,t=e.weak+e.normal+e.elite;if(t<=0)return{total:0,exp:0,upkeep:0,cost:0};const r=Ge.ARMY_POWER_WEIGHTS,a=e.weak*r.weak+e.normal*r.normal+e.elite*r.elite,o=e.weak*f.ARMY_UPKEEP_WEAK+e.normal*f.ARMY_UPKEEP_NORMAL+e.elite*f.ARMY_UPKEEP_ELITE,n=f.ARMY_DISSOLVE_TAX_BASE+a*f.ARMY_DISSOLVE_TAX_PER_EXP,i=Math.min(f.ARMY_DISSOLVE_TAX_MAX,n),l=Math.max(f.ARMY_DISSOLVE_MIN_COST,Math.ceil(o*i));return{total:t,exp:a,upkeep:o,cost:l}}renderArmyDissolveConfirm(e,t){return[{text:"> ====== RECLAIM THE DARK GIFT ======",group:"game",style:"warning"},{text:"> Are you sure you want to dissolve your legions?",group:"game",style:"creative"},{text:`> It will cost ${e} BLOOD and grant ${t} EXP.`,group:"system",style:"creative"},{text:"> [ 1 ] - Yes",group:"system",style:"creative"},{text:"> [ 2 ] - No",group:"system",style:"creative"},{text:"> =====================================",group:"game",style:"warning"}]}handleArmyDissolveConfirmInput(e){if(e==="2"||e==="0")return this.currentState="ACTION_MENU",this.pendingArmyDissolve=null,this.menuContext?.menuEngine.render()??this.nextDay();if(e!=="1"){const p=this.pendingArmyDissolve??this.getArmyDissolveValues();return[{text:`> Invalid choice: "${e}"`,group:"error"},...this.renderArmyDissolveConfirm(p.cost,p.exp)]}const{total:t,exp:r,cost:a}=this.getArmyDissolveValues();if(this.pendingArmyDissolve=null,t<=0){this.currentState="ACTION_MENU";const p=this.menuContext?.menuEngine.render()??this.nextDay();return[{text:"> You have no legions to dissolve.",group:"error"},...p]}if(this.gameState.player.blood<=a){this.currentState="ACTION_MENU";const p=this.menuContext?.menuEngine.render()??this.nextDay();return[{text:"> Your veins are too thin for this ritual.",group:"error"},{text:`> Required: ${a} BLOOD`,group:"error"},{text:`> Current: ${this.gameState.player.blood} BLOOD`,group:"system"},...p]}this.gameState.player.blood=Math.max(0,this.gameState.player.blood-a),this.gameState.army={weak:0,normal:0,elite:0};const{player:o,leveledUp:n,newLevel:i}=$e(this.gameState.player,r);this.gameState.player=o;const l=[{text:"> Your legions dissolve into ash.",group:"game",style:"creative"},{text:`> BLOOD: [ - ${a} ]`,group:"error"},...A.addExp(r)];if(n){l.push(...A.newLevel(i,de(i)));const p=z({state:this.gameState});return this.gameState=p.state,this.currentState="ATTRIBUTE_UPGRADE",[...l,...p.messages]}this.currentState="LOBBY";const u=this.endDay();return u.gameOver&&(this.finished=!0,this.currentState="GAME_OVER"),[...l,...u.messages]}handleAttributeUpgradeInput(e){const t=Number(e),r=Rt({state:this.gameState,choice:Number.isNaN(t)?-1:t});if(this.gameState=r.state,r.dayConsumed){this.currentState="LOBBY";const a=this.endDay();return a.gameOver&&(this.finished=!0,this.currentState="GAME_OVER"),[...r.messages,...a.messages]}return this.currentState="ATTRIBUTE_UPGRADE",r.messages}handleCommand(e,t){if(e==="nosferatu"&&this.currentState!=="LOBBY")return[{text:"> The blood whispers... but now is not the time.",group:"game",style:"creative"}];if(this.currentState==="CHEAT_MENU"&&this.cheatMenuManager)return this.handleCheatMenuInput(e);if(this.currentState==="VILLAGE_MENU"&&this.villageActionManager)return this.handleVillageMenuInput(e);if(this.currentState==="CASTLE_MENU"&&this.castleAssaultManager)return this.handleCastleMenuInput(e);if(this.currentState==="WIVES_MENU")return this.handleWivesListInput(e);if(this.currentState==="WIFE_SUBMENU")return this.handleWifeSubmenuInput(e);if(this.currentState==="WIFE_DETAILS")return this.handleWifeDetailsInput(e);if(this.currentState==="WIFE_CONFIRM")return this.handleWifeConfirmInput(e);if(this.currentState==="ARMY_DISSOLVE_CONFIRM")return this.handleArmyDissolveConfirmInput(e);if(this.currentState==="ATTRIBUTE_UPGRADE")return this.handleAttributeUpgradeInput(e);if(this.currentState==="BODYGUARDS_MENU"||this.currentState==="BODYGUARD_DISMISS_CONFIRM"){const a=q(this.gameState,e,this.currentState);return a.nextState&&(this.currentState=a.nextState),a.nextState==="ACTION_MENU"?[...a.messages,...this.nextDay()]:a.messages}if(this.currentState==="ACTION_MENU"&&this.menuContext)return this.handleMenuInput(e);const r=[...Nt,...Dt].find(a=>a.keys.includes(e));return r?r.run(this,t):[{text:`GAME: UNKNOWN COMMAND "${e}"`,group:"error"},...A.unknown]}isFinished(){return this.finished}help(){return A.help}credits(){return A.creator}rules(){return A.tutorial}status(){const e=St(this.gameState);return[{text:"> =============== STATUS ===============",group:"game",style:"creative"},{text:`> DAY: ${this.gameState.world.currentDay}`,group:"game",style:"creative"},{text:`> LEVEL: [ ${this.gameState.player.level} ] ' EXP: [ ${this.gameState.player.experience}/${this.gameState.player.nextLevelExpRequired} ]`,group:"game",style:"creative"},{text:`> BLOOD: [ ${this.gameState.player.blood} ]`,group:"game",style:"creative"},{text:"> ============= ATTRIBUTES =============",group:"game"},{text:`> HP: [ ${e.maxHp} ] ' STRENGTH: [ ${e.strength} ]`,group:"game"},{text:`> SPEED: [ ${e.speed} ] ' CHARISMA: [ ${e.charisma} ]`,group:"game"},{text:`> INTELLIGENCE: [ ${e.intelligence} ] ' TACTICS: [ ${e.tactics} ]`,group:"game"},{text:`> SEDUCTION: [ ${e.seduction} ]`,group:"game"},{text:"> ================ ARMY ================",group:"system"},{text:`> SHOVELHEADS: [ ${this.gameState.army.weak} ]`,group:"system"},{text:`> GHOULS: [ ${this.gameState.army.normal} ]`,group:"system"},{text:`> REVENANTS: [ ${this.gameState.army.elite} ]`,group:"system"},{text:"> ============ COMPANIONS ==============",group:"system"},{text:`> WIVES: [ ${this.gameState.companions.wives.length}/${this.gameState.companions.maxWives} ] ' BODYGUARD: [ ${this.gameState.companions.bodyguards.length>0?"YES":"NO"} ]`,group:"system"},{text:"> ======================================",group:"game",style:"creative"}]}nextDay(){if(this.checkGameOver())return this.finished=!0,A.gameOver;this.currentState="ACTION_MENU";const e=new V({title:"DAY ACTIONS",titleStyle:{group:"game",style:"creative"},prompt:"Choose your action:",promptStyle:{group:"game",style:"separator"},options:this.createDayMenu(),optionStyle:{group:"system",style:"creative"},decoration:{top:"=",bottom:"=",width:38,topStyle:{group:"game",style:"creative"},bottomStyle:{group:"game",style:"creative"}},footerText:{lines:["[ 0 ] - Back"],style:{group:"game",style:"title"}}});return this.menuContext={menuEngine:e,menuName:"DAY_ACTIONS"},this.menuContext={menuEngine:e,menuName:"DAY_ACTIONS"},e.render()}saveGame(){return["> SAVE CODE:",btoa(JSON.stringify(this.gameState)),{text:"> USE: load <code>",group:"game",style:"separator"}]}loadGame(e){if(!e)return[{text:"> LOAD FAILED: NO SAVE CODE PROVIDED",group:"error"}];try{const t=atob(e.trim()),r=JSON.parse(t);if(!r.meta||!r.player)throw new Error("Invalid save structure");return this.gameState=r,this.currentState="LOBBY",this.menuContext=null,[{text:"> SAVE LOADED SUCCESSFULLY",group:"game"},{text:`> ^(o,_,o)^ Welcome back on day ${this.gameState.world.currentDay}...`,group:"system",style:"separator"}]}catch{return[{text:"> LOAD FAILED: CORRUPTED SAVE CODE",group:"error"}]}}exit(){return this.finished=!0,A.exit}openCheatMenu(){this.currentState="CHEAT_MENU",this.cheatMenuManager=new Rr;const e=this.cheatMenuManager.start(this.gameState);return this.gameState=e.state,e.messages}endDay(){const e=[];this.gameState.world.currentDay+=1,this.gameState.companions.wives.forEach(o=>o.daysTogether+=1),this.gameState.statistics.daysPlayed+=1,this.gameState.companions.bodyguards.forEach(o=>o.daysInService+=1);const t=Sr(this.gameState);t.hasGeneration&&(e.push({text:"> Your consorts whisper in the dark, ensnaring new souls for your cause.",group:"game",style:"separator"}),t.generated.weak>0&&e.push({text:`> +${t.generated.weak} SHOVELHEADS`,group:"system",style:"separator"}),t.generated.normal>0&&e.push({text:`> +${t.generated.normal} GHOULS`,group:"system",style:"separator"}),t.generated.elite>0&&e.push({text:`> +${t.generated.elite} REVENANTS`,group:"system",style:"separator"}));const r=Bt(this.gameState);return e.push({text:"....../|../|../|....",group:"system",style:"separator"}),e.push({text:".....| |.| |.| |....",group:"system",style:"separator"}),e.push({text:".....| |.| |.| |....",group:"system",style:"separator"}),e.push({text:".....\\ \\.| |./ /....",group:"system",style:"separator"}),e.push({text:"......\\ \\/ \\/ /.....",group:"system",style:"separator"}),e.push({text:".......\\...../......",group:"system",style:"separator"}),e.push({text:"........-----.......",group:"system",style:"separator"}),e.push({text:`> Blood Toll: -${r.cost} BLOOD`,group:"error"}),{messages:this.checkForDefeat(e),gameOver:this.currentState==="GAME_OVER"}}handleCheatMenuInput(e){if(!this.cheatMenuManager)return["> ERROR: Cheat menu not initialized"];const t=this.cheatMenuManager.handleCommand(e,this.gameState);return this.gameState=t.state,t.exit&&(this.currentState="LOBBY",this.cheatMenuManager=null),t.messages}handleVillageMenuInput(e){if(!this.villageActionManager)return["> ERROR: Village action manager not initialized"];const t=this.villageActionManager.handleCommand(e,this.gameState);this.gameState=t.state;let r=t.messages;if(r=this.checkForDefeat(r),this.currentState==="GAME_OVER")return this.villageActionManager=null,r;if(t.nextState==="ATTRIBUTE_UPGRADE")return r;if(t.nextState==="LOBBY"&&(this.currentState="LOBBY",this.villageActionManager=null),t.dayConsumed){this.currentState="LOBBY",this.villageActionManager=null;const a=this.endDay();return a.gameOver&&(this.finished=!0,this.currentState="GAME_OVER"),[...r,...a.messages]}return t.gameOver&&(this.finished=!0,this.currentState="GAME_OVER",this.villageActionManager=null),r}handleCastleMenuInput(e){if(!this.castleAssaultManager)return["> ERROR: Castle assault manager not initialized"];const t=this.castleAssaultManager.handleCommand(e,this.gameState);this.gameState=t.state;let r=t.messages;if(r=this.checkForDefeat(r),this.currentState==="GAME_OVER")return this.castleAssaultManager=null,r;if(t.nextState==="LOBBY"&&(this.currentState="LOBBY",this.castleAssaultManager=null),t.gameOver)return this.finished=!0,this.currentState="GAME_OVER",this.castleAssaultManager=null,r;if(t.nextState==="LOBBY"&&!t.dayConsumed)return this.currentState="ACTION_MENU",this.castleAssaultManager=null,[...r,...this.nextDay()];if(t.dayConsumed){this.currentState="LOBBY",this.castleAssaultManager=null;const a=this.endDay();return a.gameOver&&(this.finished=!0,this.currentState="GAME_OVER"),[...r,...a.messages]}return r}handleMenuInput(e){if(!this.menuContext)return["> ERROR: No menu context"];const t=this.menuContext.menuEngine.processInput(e);return t?this.executeMenuAction(t.optionId):e==="0"||e==="ex"||e==="exit"?(this.currentState="LOBBY",this.menuContext=null,[`> CANCELLED! ${A.back}`]):[{text:`GAME: INVALID SELECTION: "${e}"! Try again...`,group:"error"},...this.renderCurrentMenu()]}executeMenuAction(e){if(e==="wives"){this.currentState="WIVES_MENU",this.wivesContext={selectedIndex:null};const r=we({state:this.gameState});return r.nextState==="LOBBY"?(this.currentState="LOBBY",[...r.messages,...this.nextDay()]):r.messages}if(e==="village"){this.currentState="VILLAGE_MENU",this.villageActionManager=new ns;const r=this.villageActionManager.handleCommand("village_start",this.gameState);return this.gameState=r.state,r.messages}if(e==="dismiss_army"){const{total:r,exp:a,cost:o}=this.getArmyDissolveValues();return r<=0?[{text:"> You have no legions to dissolve.",group:"error"},...this.renderCurrentMenu()]:(this.pendingArmyDissolve={cost:o,exp:a},this.currentState="ARMY_DISSOLVE_CONFIRM",this.renderArmyDissolveConfirm(o,a))}if(e==="castle"){this.currentState="CASTLE_MENU",this.castleAssaultManager=new Ar;const r=this.castleAssaultManager.handleCommand("castle_start",this.gameState);return this.gameState=r.state,r.messages}if(e==="bodyguard"){const r=q(this.gameState);return r.nextState?this.currentState=r.nextState:this.currentState=this.gameState.companions.bodyguards.length===0?"ACTION_MENU":"BODYGUARDS_MENU",[...r.messages,...this.nextDay()]}if(e==="skipday"){const r=this.endDay();return this.currentState="LOBBY",r.gameOver&&(this.finished=!0,this.currentState="GAME_OVER"),[{text:"> You retreat to the safety of your lair...",group:"game",style:"creative"},{text:"> The sun dies, and the day fades in silence.",group:"game",style:"creative"},...r.messages,{text:`> NIGHT ${this.gameState.world.currentDay}. THE HUNT ASCENDS!`,group:"game",style:"creative"}]}this.currentState="PROCESSING_ACTION";const t=this.performAction(e);return t.gameOver?(this.finished=!0,this.currentState="GAME_OVER"):this.currentState="LOBBY",t.messages}renderCurrentMenu(){return this.menuContext?this.menuContext.menuEngine.render():[]}createDayMenu(){return[{id:"village",label:'Stalk Village ^-";;"-^',disabled:!1},{id:"castle",label:'Lupine Siege |"|l|"|',disabled:this.gameState.player.level<g.LEVEL_UNLOCK_CASTLE},{id:"wives",label:"Your Consorts (♥,_,♥)",disabled:this.gameState.player.level<g.LEVEL_UNLOCK_WIFE},{id:"bodyguard",label:"Your Bodyguard :(=,_,=)-|",disabled:this.gameState.player.level<g.LEVEL_UNLOCK_BODYGUARD},{id:"dismiss_army",label:"Reclaim the Dark Gift (Dissolve your legions)",disabled:!1},{id:"skipday",label:"Awaken the Next Night (-,_,-)",disabled:!1}]}performAction(e){switch(e){case"village":return oe({state:this.gameState});case"castle":return ie({state:this.gameState});default:return{state:this.gameState,messages:["> UNKNOWN ACTION"],dayConsumed:!1}}}checkGameOver(){return this.gameState.player.blood<=0}createInitialSave(){return{meta:{version:D.SAVE_VERSION,lastSaveDay:0},world:{currentDay:1},player:{level:D.INITIAL_LEVEL,experience:0,nextLevelExpRequired:20,attributePointsAvailable:0,blood:D.INITIAL_BLOOD,stats:{maxHp:D.INITIAL_MAX_HP,strength:D.INITIAL_STRENGTH,speed:D.INITIAL_SPEED,charisma:D.INITIAL_CHARISMA,intelligence:D.INITIAL_INTELLIGENCE,tactics:D.INITIAL_TACTICS,seduction:D.INITIAL_SEDUCTION},combatState:{currentHp:D.INITIAL_MAX_HP}},army:{weak:0,normal:0,elite:0},companions:{wives:[],maxWives:D.INITIAL_MAX_WIVES,bodyguards:[]},villages:{maxVisible:7,list:[]},statistics:{daysPlayed:0,changedWives:0,changedBodyguards:0,enslavedVillagers:{weak:0,normal:0,elite:0},defeatedGuards:0,ravagedVillages:0,conqueredCastles:0}}}}const Cr={id:"vampire",command:"2",title:"VAMPIRE REQUIEM ^(o,_,o)^",description:["Darkness falls! Step into the shoes of a powerful vampire and crush the werewolf menace! Sss..."],order:2,create(){return new gt},intro(){const s=new gt;return[{text:"> "+this.title+" - [STARTED]",group:"game",style:"title"},{text:"> ======================================",group:"game",style:"description"},{text:"> "+this.description,group:"game",style:"description"},{text:"> ======================================",group:"game",style:"description"},{text:"> You are a powerful vampire prince.",group:"game",style:"description"},{text:'> To endure another night, enter "3".',group:"game",style:"description"},...s.help()]}};export{Cr as default};
